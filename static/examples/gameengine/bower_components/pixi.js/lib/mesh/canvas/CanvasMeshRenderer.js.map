{"version":3,"sources":["../../../src/mesh/canvas/CanvasMeshRenderer.js"],"names":["core","MeshSpriteRenderer","renderer","render","mesh","context","transform","worldTransform","res","resolution","roundPixels","setTransform","a","b","c","d","tx","ty","setBlendMode","blendMode","drawMode","DRAW_MODES","TRIANGLE_MESH","_renderTriangleMesh","_renderTriangles","length","vertices","i","index","_renderDrawTriangle","indices","index0","index1","index2","uvs","texture","_texture","valid","base","baseTexture","textureSource","source","textureWidth","width","textureHeight","height","u0","u1","u2","v0","v1","v2","x0","x1","x2","y0","y1","y2","canvasPadding","paddingX","paddingY","centerX","centerY","normX","normY","dist","Math","sqrt","save","beginPath","moveTo","lineTo","closePath","clip","delta","deltaA","deltaB","deltaC","deltaD","deltaE","deltaF","drawImage","restore","renderMeshFlat","fillStyle","fill","destroy","CanvasRenderer","registerPlugin"],"mappings":"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","file":"CanvasMeshRenderer.js","sourcesContent":["import * as core from '../../core';\nimport { default as Mesh } from '../Mesh';\n\n/**\n * Renderer dedicated to meshes.\n *\n * @class\n * @private\n * @memberof PIXI\n */\nexport default class MeshSpriteRenderer\n{\n    /**\n     * @param {PIXI.CanvasRenderer} renderer - The renderer this downport works for\n     */\n    constructor(renderer)\n    {\n        this.renderer = renderer;\n    }\n\n    /**\n     * Renders the Mesh\n     *\n     * @param {PIXI.mesh.Mesh} mesh - the Mesh to render\n     */\n    render(mesh)\n    {\n        const renderer = this.renderer;\n        const context = renderer.context;\n\n        const transform = mesh.worldTransform;\n        const res = renderer.resolution;\n\n        if (renderer.roundPixels)\n        {\n            context.setTransform(\n                transform.a * res,\n                transform.b * res,\n                transform.c * res,\n                transform.d * res,\n                (transform.tx * res) | 0,\n                (transform.ty * res) | 0\n            );\n        }\n        else\n        {\n            context.setTransform(\n                transform.a * res,\n                transform.b * res,\n                transform.c * res,\n                transform.d * res,\n                transform.tx * res,\n                transform.ty * res\n            );\n        }\n\n        renderer.setBlendMode(mesh.blendMode);\n\n        if (mesh.drawMode === Mesh.DRAW_MODES.TRIANGLE_MESH)\n        {\n            this._renderTriangleMesh(mesh);\n        }\n        else\n        {\n            this._renderTriangles(mesh);\n        }\n    }\n\n    /**\n     * Draws the object in Triangle Mesh mode\n     *\n     * @private\n     * @param {PIXI.mesh.Mesh} mesh - the Mesh to render\n     */\n    _renderTriangleMesh(mesh)\n    {\n        // draw triangles!!\n        const length = mesh.vertices.length / 2;\n\n        for (let i = 0; i < length - 2; i++)\n        {\n            // draw some triangles!\n            const index = i * 2;\n\n            this._renderDrawTriangle(mesh, index, (index + 2), (index + 4));\n        }\n    }\n\n    /**\n     * Draws the object in triangle mode using canvas\n     *\n     * @private\n     * @param {PIXI.mesh.Mesh} mesh - the current mesh\n     */\n    _renderTriangles(mesh)\n    {\n        // draw triangles!!\n        const indices = mesh.indices;\n        const length = indices.length;\n\n        for (let i = 0; i < length; i += 3)\n        {\n            // draw some triangles!\n            const index0 = indices[i] * 2;\n            const index1 = indices[i + 1] * 2;\n            const index2 = indices[i + 2] * 2;\n\n            this._renderDrawTriangle(mesh, index0, index1, index2);\n        }\n    }\n\n    /**\n     * Draws one of the triangles that from the Mesh\n     *\n     * @private\n     * @param {PIXI.mesh.Mesh} mesh - the current mesh\n     * @param {number} index0 - the index of the first vertex\n     * @param {number} index1 - the index of the second vertex\n     * @param {number} index2 - the index of the third vertex\n     */\n    _renderDrawTriangle(mesh, index0, index1, index2)\n    {\n        const context = this.renderer.context;\n        const uvs = mesh.uvs;\n        const vertices = mesh.vertices;\n        const texture = mesh._texture;\n\n        if (!texture.valid)\n        {\n            return;\n        }\n\n        const base = texture.baseTexture;\n        const textureSource = base.source;\n        const textureWidth = base.width;\n        const textureHeight = base.height;\n\n        const u0 = uvs[index0] * base.width;\n        const u1 = uvs[index1] * base.width;\n        const u2 = uvs[index2] * base.width;\n        const v0 = uvs[index0 + 1] * base.height;\n        const v1 = uvs[index1 + 1] * base.height;\n        const v2 = uvs[index2 + 1] * base.height;\n\n        let x0 = vertices[index0];\n        let x1 = vertices[index1];\n        let x2 = vertices[index2];\n        let y0 = vertices[index0 + 1];\n        let y1 = vertices[index1 + 1];\n        let y2 = vertices[index2 + 1];\n\n        if (mesh.canvasPadding > 0)\n        {\n            const paddingX = mesh.canvasPadding / mesh.worldTransform.a;\n            const paddingY = mesh.canvasPadding / mesh.worldTransform.d;\n            const centerX = (x0 + x1 + x2) / 3;\n            const centerY = (y0 + y1 + y2) / 3;\n\n            let normX = x0 - centerX;\n            let normY = y0 - centerY;\n\n            let dist = Math.sqrt((normX * normX) + (normY * normY));\n\n            x0 = centerX + ((normX / dist) * (dist + paddingX));\n            y0 = centerY + ((normY / dist) * (dist + paddingY));\n\n            //\n\n            normX = x1 - centerX;\n            normY = y1 - centerY;\n\n            dist = Math.sqrt((normX * normX) + (normY * normY));\n            x1 = centerX + ((normX / dist) * (dist + paddingX));\n            y1 = centerY + ((normY / dist) * (dist + paddingY));\n\n            normX = x2 - centerX;\n            normY = y2 - centerY;\n\n            dist = Math.sqrt((normX * normX) + (normY * normY));\n            x2 = centerX + ((normX / dist) * (dist + paddingX));\n            y2 = centerY + ((normY / dist) * (dist + paddingY));\n        }\n\n        context.save();\n        context.beginPath();\n\n        context.moveTo(x0, y0);\n        context.lineTo(x1, y1);\n        context.lineTo(x2, y2);\n\n        context.closePath();\n\n        context.clip();\n\n        // Compute matrix transform\n        const delta = (u0 * v1) + (v0 * u2) + (u1 * v2) - (v1 * u2) - (v0 * u1) - (u0 * v2);\n        const deltaA = (x0 * v1) + (v0 * x2) + (x1 * v2) - (v1 * x2) - (v0 * x1) - (x0 * v2);\n        const deltaB = (u0 * x1) + (x0 * u2) + (u1 * x2) - (x1 * u2) - (x0 * u1) - (u0 * x2);\n        const deltaC = (u0 * v1 * x2) + (v0 * x1 * u2) + (x0 * u1 * v2) - (x0 * v1 * u2) - (v0 * u1 * x2) - (u0 * x1 * v2);\n        const deltaD = (y0 * v1) + (v0 * y2) + (y1 * v2) - (v1 * y2) - (v0 * y1) - (y0 * v2);\n        const deltaE = (u0 * y1) + (y0 * u2) + (u1 * y2) - (y1 * u2) - (y0 * u1) - (u0 * y2);\n        const deltaF = (u0 * v1 * y2) + (v0 * y1 * u2) + (y0 * u1 * v2) - (y0 * v1 * u2) - (v0 * u1 * y2) - (u0 * y1 * v2);\n\n        context.transform(\n            deltaA / delta,\n            deltaD / delta,\n            deltaB / delta,\n            deltaE / delta,\n            deltaC / delta,\n            deltaF / delta\n        );\n\n        context.drawImage(\n            textureSource,\n            0,\n            0,\n            textureWidth * base.resolution,\n            textureHeight * base.resolution,\n            0,\n            0,\n            textureWidth,\n            textureHeight\n        );\n\n        context.restore();\n    }\n\n    /**\n     * Renders a flat Mesh\n     *\n     * @private\n     * @param {PIXI.mesh.Mesh} mesh - The Mesh to render\n     */\n    renderMeshFlat(mesh)\n    {\n        const context = this.renderer.context;\n        const vertices = mesh.vertices;\n        const length = vertices.length / 2;\n\n        // this.count++;\n\n        context.beginPath();\n\n        for (let i = 1; i < length - 2; ++i)\n        {\n            // draw some triangles!\n            const index = i * 2;\n\n            const x0 = vertices[index];\n            const y0 = vertices[index + 1];\n\n            const x1 = vertices[index + 2];\n            const y1 = vertices[index + 3];\n\n            const x2 = vertices[index + 4];\n            const y2 = vertices[index + 5];\n\n            context.moveTo(x0, y0);\n            context.lineTo(x1, y1);\n            context.lineTo(x2, y2);\n        }\n\n        context.fillStyle = '#FF0000';\n        context.fill();\n        context.closePath();\n    }\n\n    /**\n     * destroy the the renderer.\n     *\n     */\n    destroy()\n    {\n        this.renderer = null;\n    }\n}\n\ncore.CanvasRenderer.registerPlugin('mesh', MeshSpriteRenderer);\n"]}