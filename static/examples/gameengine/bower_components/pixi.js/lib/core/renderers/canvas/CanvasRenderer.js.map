{"version":3,"sources":["../../../../src/core/renderers/canvas/CanvasRenderer.js"],"names":["CanvasRenderer","width","height","options","type","CANVAS","rootContext","view","getContext","alpha","transparent","refresh","maskManager","smoothProperty","imageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled","oImageSmoothingEnabled","msImageSmoothingEnabled","initPlugins","blendModes","_activeBlendMode","context","renderingToScreen","resize","render","displayObject","renderTexture","clear","transform","skipUpdateTransform","emit","baseTexture","_canvasRenderTarget","resolution","source","canvas","valid","_lastObjectRendered","cacheParent","parent","tempWt","_tempDisplayObjectParent","worldTransform","copy","identity","updateTransform","setTransform","globalAlpha","globalCompositeOperation","NORMAL","navigator","isCocoonJS","screencanvas","fillStyle","undefined","clearBeforeRender","clearRect","_backgroundColorString","fillRect","tempContext","renderCanvas","setBlendMode","blendMode","destroy","removeView","destroyPlugins","SCALE_MODE","LINEAR","mixin"],"mappings":"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","file":"CanvasRenderer.js","sourcesContent":["import SystemRenderer from '../SystemRenderer';\nimport CanvasMaskManager from './utils/CanvasMaskManager';\nimport CanvasRenderTarget from './utils/CanvasRenderTarget';\nimport mapCanvasBlendModesToPixi from './utils/mapCanvasBlendModesToPixi';\nimport { pluginTarget } from '../../utils';\nimport { RENDERER_TYPE, SCALE_MODES, BLEND_MODES } from '../../const';\nimport settings from '../../settings';\n\n/**\n * The CanvasRenderer draws the scene and all its content onto a 2d canvas. This renderer should\n * be used for browsers that do not support WebGL. Don't forget to add the CanvasRenderer.view to\n * your DOM or you will not see anything :)\n *\n * @class\n * @memberof PIXI\n * @extends PIXI.SystemRenderer\n */\nexport default class CanvasRenderer extends SystemRenderer\n{\n    /**\n     * @param {number} [width=800] - the width of the canvas view\n     * @param {number} [height=600] - the height of the canvas view\n     * @param {object} [options] - The optional renderer parameters\n     * @param {HTMLCanvasElement} [options.view] - the canvas to use as a view, optional\n     * @param {boolean} [options.transparent=false] - If the render view is transparent, default false\n     * @param {boolean} [options.autoResize=false] - If the render view is automatically resized, default false\n     * @param {boolean} [options.antialias=false] - sets antialias (only applicable in chrome at the moment)\n     * @param {number} [options.resolution=1] - The resolution / device pixel ratio of the renderer. The\n     *  resolution of the renderer retina would be 2.\n     * @param {boolean} [options.clearBeforeRender=true] - This sets if the CanvasRenderer will clear the canvas or\n     *      not before the new render pass.\n     * @param {number} [options.backgroundColor=0x000000] - The background color of the rendered area\n     *  (shown if not transparent).\n     * @param {boolean} [options.roundPixels=false] - If true Pixi will Math.floor() x/y values when rendering,\n     *  stopping pixel interpolation.\n     */\n    constructor(width, height, options = {})\n    {\n        super('Canvas', width, height, options);\n\n        this.type = RENDERER_TYPE.CANVAS;\n\n        /**\n         * The canvas 2d context that everything is drawn with.\n         *\n         * @member {CanvasRenderingContext2D}\n         */\n        this.rootContext = this.view.getContext('2d', { alpha: this.transparent });\n\n        /**\n         * Boolean flag controlling canvas refresh.\n         *\n         * @member {boolean}\n         */\n        this.refresh = true;\n\n        /**\n         * Instance of a CanvasMaskManager, handles masking when using the canvas renderer.\n         *\n         * @member {PIXI.CanvasMaskManager}\n         */\n        this.maskManager = new CanvasMaskManager(this);\n\n        /**\n         * The canvas property used to set the canvas smoothing property.\n         *\n         * @member {string}\n         */\n        this.smoothProperty = 'imageSmoothingEnabled';\n\n        if (!this.rootContext.imageSmoothingEnabled)\n        {\n            if (this.rootContext.webkitImageSmoothingEnabled)\n            {\n                this.smoothProperty = 'webkitImageSmoothingEnabled';\n            }\n            else if (this.rootContext.mozImageSmoothingEnabled)\n            {\n                this.smoothProperty = 'mozImageSmoothingEnabled';\n            }\n            else if (this.rootContext.oImageSmoothingEnabled)\n            {\n                this.smoothProperty = 'oImageSmoothingEnabled';\n            }\n            else if (this.rootContext.msImageSmoothingEnabled)\n            {\n                this.smoothProperty = 'msImageSmoothingEnabled';\n            }\n        }\n\n        this.initPlugins();\n\n        this.blendModes = mapCanvasBlendModesToPixi();\n        this._activeBlendMode = null;\n\n        this.context = null;\n        this.renderingToScreen = false;\n\n        this.resize(width, height);\n    }\n\n    /**\n     * Renders the object to this canvas view\n     *\n     * @param {PIXI.DisplayObject} displayObject - The object to be rendered\n     * @param {PIXI.RenderTexture} [renderTexture] - A render texture to be rendered to.\n     *  If unset, it will render to the root context.\n     * @param {boolean} [clear=false] - Whether to clear the canvas before drawing\n     * @param {PIXI.Transform} [transform] - A transformation to be applied\n     * @param {boolean} [skipUpdateTransform=false] - Whether to skip the update transform\n     */\n    render(displayObject, renderTexture, clear, transform, skipUpdateTransform)\n    {\n        if (!this.view)\n        {\n            return;\n        }\n\n        // can be handy to know!\n        this.renderingToScreen = !renderTexture;\n\n        this.emit('prerender');\n\n        if (renderTexture)\n        {\n            renderTexture = renderTexture.baseTexture || renderTexture;\n\n            if (!renderTexture._canvasRenderTarget)\n            {\n                renderTexture._canvasRenderTarget = new CanvasRenderTarget(\n                    renderTexture.width,\n                    renderTexture.height,\n                    renderTexture.resolution\n                );\n                renderTexture.source = renderTexture._canvasRenderTarget.canvas;\n                renderTexture.valid = true;\n            }\n\n            this.context = renderTexture._canvasRenderTarget.context;\n            this.resolution = renderTexture._canvasRenderTarget.resolution;\n        }\n        else\n        {\n            this.context = this.rootContext;\n        }\n\n        const context = this.context;\n\n        if (!renderTexture)\n        {\n            this._lastObjectRendered = displayObject;\n        }\n\n        if (!skipUpdateTransform)\n        {\n            // update the scene graph\n            const cacheParent = displayObject.parent;\n            const tempWt = this._tempDisplayObjectParent.transform.worldTransform;\n\n            if (transform)\n            {\n                transform.copy(tempWt);\n            }\n            else\n            {\n                tempWt.identity();\n            }\n\n            displayObject.parent = this._tempDisplayObjectParent;\n            displayObject.updateTransform();\n            displayObject.parent = cacheParent;\n            // displayObject.hitArea = //TODO add a temp hit area\n        }\n\n        context.setTransform(1, 0, 0, 1, 0, 0);\n        context.globalAlpha = 1;\n        context.globalCompositeOperation = this.blendModes[BLEND_MODES.NORMAL];\n\n        if (navigator.isCocoonJS && this.view.screencanvas)\n        {\n            context.fillStyle = 'black';\n            context.clear();\n        }\n\n        if (clear !== undefined ? clear : this.clearBeforeRender)\n        {\n            if (this.renderingToScreen)\n            {\n                if (this.transparent)\n                {\n                    context.clearRect(0, 0, this.width, this.height);\n                }\n                else\n                {\n                    context.fillStyle = this._backgroundColorString;\n                    context.fillRect(0, 0, this.width, this.height);\n                }\n            } // else {\n            // TODO: implement background for CanvasRenderTarget or RenderTexture?\n            // }\n        }\n\n        // TODO RENDER TARGET STUFF HERE..\n        const tempContext = this.context;\n\n        this.context = context;\n        displayObject.renderCanvas(this);\n        this.context = tempContext;\n\n        this.emit('postrender');\n    }\n\n    /**\n     * Sets the blend mode of the renderer.\n     *\n     * @param {number} blendMode - See {@link PIXI.BLEND_MODES} for valid values.\n     */\n    setBlendMode(blendMode)\n    {\n        if (this._activeBlendMode === blendMode)\n        {\n            return;\n        }\n\n        this._activeBlendMode = blendMode;\n        this.context.globalCompositeOperation = this.blendModes[blendMode];\n    }\n\n    /**\n     * Removes everything from the renderer and optionally removes the Canvas DOM element.\n     *\n     * @param {boolean} [removeView=false] - Removes the Canvas element from the DOM.\n     */\n    destroy(removeView)\n    {\n        this.destroyPlugins();\n\n        // call the base destroy\n        super.destroy(removeView);\n\n        this.context = null;\n\n        this.refresh = true;\n\n        this.maskManager.destroy();\n        this.maskManager = null;\n\n        this.smoothProperty = null;\n    }\n\n    /**\n     * Resizes the canvas view to the specified width and height.\n     *\n     * @extends PIXI.SystemRenderer#resize\n     *\n     * @param {number} width - The new width of the canvas view\n     * @param {number} height - The new height of the canvas view\n     */\n    resize(width, height)\n    {\n        super.resize(width, height);\n\n        // reset the scale mode.. oddly this seems to be reset when the canvas is resized.\n        // surely a browser bug?? Let pixi fix that for you..\n        if (this.smoothProperty)\n        {\n            this.rootContext[this.smoothProperty] = (settings.SCALE_MODE === SCALE_MODES.LINEAR);\n        }\n    }\n}\n\npluginTarget.mixin(CanvasRenderer);\n"]}