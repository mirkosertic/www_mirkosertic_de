{"version":3,"sources":["../../src/loaders/bitmapFontParser.js"],"names":["parse","bitmapFontParser","resource","next","data","isXml","getElementsByTagName","length","getAttribute","xmlUrl","isDataUrl","path","dirname","url","baseUrl","charAt","replace","textureUrl","TextureCache","loadOptions","crossOrigin","loadType","LOAD_TYPE","IMAGE","metadata","imageMetadata","add","name","res","texture","info","common","font","size","parseInt","lineHeight","chars","letters","i","charCode","textureRect","frame","x","y","xOffset","yOffset","xAdvance","kerning","baseTexture","kernings","first","second","amount","bitmapFont","fonts"],"mappings":";;;QAKgBA,K,GAAAA,K;;kBAyDD,YACf;AACI,WAAO,SAASC,gBAAT,CAA0BC,QAA1B,EAAoCC,IAApC,EACP;AACI;AACA,YAAI,CAACD,SAASE,IAAV,IAAkB,CAACF,SAASG,KAAhC,EACA;AACIF;;AAEA;AACH;;AAED;AACA,YAAID,SAASE,IAAT,CAAcE,oBAAd,CAAmC,MAAnC,EAA2CC,MAA3C,KAAsD,CAAtD,IACGL,SAASE,IAAT,CAAcE,oBAAd,CAAmC,MAAnC,EAA2CC,MAA3C,KAAsD,CADzD,IAEGL,SAASE,IAAT,CAAcE,oBAAd,CAAmC,MAAnC,EAA2C,CAA3C,EAA8CE,YAA9C,CAA2D,MAA3D,MAAuE,IAF9E,EAIA;AACIL;;AAEA;AACH;;AAED,YAAIM,SAAS,CAACP,SAASQ,SAAV,GAAsBC,KAAKC,OAAL,CAAaV,SAASW,GAAtB,CAAtB,GAAmD,EAAhE;;AAEA,YAAIX,SAASQ,SAAb,EACA;AACI,gBAAID,WAAW,GAAf,EACA;AACIA,yBAAS,EAAT;AACH;;AAED,gBAAI,KAAKK,OAAL,IAAgBL,MAApB,EACA;AACI;AACA,oBAAI,KAAKK,OAAL,CAAaC,MAAb,CAAoB,KAAKD,OAAL,CAAaP,MAAb,GAAsB,CAA1C,MAAiD,GAArD,EACA;AACIE,8BAAU,GAAV;AACH;;AAED;AACAA,yBAASA,OAAOO,OAAP,CAAe,KAAKF,OAApB,EAA6B,EAA7B,CAAT;AACH;AACJ;;AAED;AACA,YAAIL,UAAUA,OAAOM,MAAP,CAAcN,OAAOF,MAAP,GAAgB,CAA9B,MAAqC,GAAnD,EACA;AACIE,sBAAU,GAAV;AACH;;AAED,YAAMQ,aAAaR,SAASP,SAASE,IAAT,CAAcE,oBAAd,CAAmC,MAAnC,EAA2C,CAA3C,EAA8CE,YAA9C,CAA2D,MAA3D,CAA5B;;AAEA,YAAI,YAAMU,YAAN,CAAmBD,UAAnB,CAAJ,EACA;AACI;AACAjB,kBAAME,QAAN,EAAgB,YAAMgB,YAAN,CAAmBD,UAAnB,CAAhB;AACAd;AACH,SALD,MAOA;AACI,gBAAMgB,cAAc;AAChBC,6BAAalB,SAASkB,WADN;AAEhBC,0BAAU,yBAASC,SAAT,CAAmBC,KAFb;AAGhBC,0BAAUtB,SAASsB,QAAT,CAAkBC;AAHZ,aAApB;;AAMA;AACA,iBAAKC,GAAL,CAAYxB,SAASyB,IAArB,aAAmCV,UAAnC,EAA+CE,WAA/C,EAA4D,UAACS,GAAD,EAC5D;AACI5B,sBAAME,QAAN,EAAgB0B,IAAIC,OAApB;AACA1B;AACH,aAJD;AAKH;AACJ,KAxED;AAyEH,C;;AAzID;;IAAYQ,I;;AACZ;;AACA;;AACA;;;;AAEO,SAASX,KAAT,CAAeE,QAAf,EAAyB2B,OAAzB,EACP;AACI,QAAMzB,OAAO,EAAb;AACA,QAAM0B,OAAO5B,SAASE,IAAT,CAAcE,oBAAd,CAAmC,MAAnC,EAA2C,CAA3C,CAAb;AACA,QAAMyB,SAAS7B,SAASE,IAAT,CAAcE,oBAAd,CAAmC,QAAnC,EAA6C,CAA7C,CAAf;;AAEAF,SAAK4B,IAAL,GAAYF,KAAKtB,YAAL,CAAkB,MAAlB,CAAZ;AACAJ,SAAK6B,IAAL,GAAYC,SAASJ,KAAKtB,YAAL,CAAkB,MAAlB,CAAT,EAAoC,EAApC,CAAZ;AACAJ,SAAK+B,UAAL,GAAkBD,SAASH,OAAOvB,YAAP,CAAoB,YAApB,CAAT,EAA4C,EAA5C,CAAlB;AACAJ,SAAKgC,KAAL,GAAa,EAAb;;AAEA;AACA,QAAMC,UAAUnC,SAASE,IAAT,CAAcE,oBAAd,CAAmC,MAAnC,CAAhB;;AAEA,SAAK,IAAIgC,IAAI,CAAb,EAAgBA,IAAID,QAAQ9B,MAA5B,EAAoC+B,GAApC,EACA;AACI,YAAMC,WAAWL,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,IAAxB,CAAT,EAAwC,EAAxC,CAAjB;;AAEA,YAAMgC,cAAc,oBAChBN,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,GAAxB,CAAT,EAAuC,EAAvC,IAA6CqB,QAAQY,KAAR,CAAcC,CAD3C,EAEhBR,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,GAAxB,CAAT,EAAuC,EAAvC,IAA6CqB,QAAQY,KAAR,CAAcE,CAF3C,EAGhBT,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,OAAxB,CAAT,EAA2C,EAA3C,CAHgB,EAIhB0B,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,QAAxB,CAAT,EAA4C,EAA5C,CAJgB,CAApB;;AAOAJ,aAAKgC,KAAL,CAAWG,QAAX,IAAuB;AACnBK,qBAASV,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,SAAxB,CAAT,EAA6C,EAA7C,CADU;AAEnBqC,qBAASX,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,SAAxB,CAAT,EAA6C,EAA7C,CAFU;AAGnBsC,sBAAUZ,SAASG,QAAQC,CAAR,EAAW9B,YAAX,CAAwB,UAAxB,CAAT,EAA8C,EAA9C,CAHS;AAInBuC,qBAAS,EAJU;AAKnBlB,qBAAS,kBAAYA,QAAQmB,WAApB,EAAiCR,WAAjC;;AALU,SAAvB;AAQH;;AAED;AACA,QAAMS,WAAW/C,SAASE,IAAT,CAAcE,oBAAd,CAAmC,SAAnC,CAAjB;;AAEA,SAAK,IAAIgC,KAAI,CAAb,EAAgBA,KAAIW,SAAS1C,MAA7B,EAAqC+B,IAArC,EACA;AACI,YAAMY,QAAQhB,SAASe,SAASX,EAAT,EAAY9B,YAAZ,CAAyB,OAAzB,CAAT,EAA4C,EAA5C,CAAd;AACA,YAAM2C,SAASjB,SAASe,SAASX,EAAT,EAAY9B,YAAZ,CAAyB,QAAzB,CAAT,EAA6C,EAA7C,CAAf;AACA,YAAM4C,SAASlB,SAASe,SAASX,EAAT,EAAY9B,YAAZ,CAAyB,QAAzB,CAAT,EAA6C,EAA7C,CAAf;;AAEA,YAAIJ,KAAKgC,KAAL,CAAWe,MAAX,CAAJ,EACA;AACI/C,iBAAKgC,KAAL,CAAWe,MAAX,EAAmBJ,OAAnB,CAA2BG,KAA3B,IAAoCE,MAApC;AACH;AACJ;;AAEDlD,aAASmD,UAAT,GAAsBjD,IAAtB;;AAEA;AACA;AACA,uBAAWkD,KAAX,CAAiBlD,KAAK4B,IAAtB,IAA8B5B,IAA9B;AACH","file":"bitmapFontParser.js","sourcesContent":["import * as path from 'path';\nimport { Rectangle, Texture, utils } from '../core';\nimport { Resource } from 'resource-loader';\nimport { BitmapText } from '../extras';\n\nexport function parse(resource, texture)\n{\n    const data = {};\n    const info = resource.data.getElementsByTagName('info')[0];\n    const common = resource.data.getElementsByTagName('common')[0];\n\n    data.font = info.getAttribute('face');\n    data.size = parseInt(info.getAttribute('size'), 10);\n    data.lineHeight = parseInt(common.getAttribute('lineHeight'), 10);\n    data.chars = {};\n\n    // parse letters\n    const letters = resource.data.getElementsByTagName('char');\n\n    for (let i = 0; i < letters.length; i++)\n    {\n        const charCode = parseInt(letters[i].getAttribute('id'), 10);\n\n        const textureRect = new Rectangle(\n            parseInt(letters[i].getAttribute('x'), 10) + texture.frame.x,\n            parseInt(letters[i].getAttribute('y'), 10) + texture.frame.y,\n            parseInt(letters[i].getAttribute('width'), 10),\n            parseInt(letters[i].getAttribute('height'), 10)\n        );\n\n        data.chars[charCode] = {\n            xOffset: parseInt(letters[i].getAttribute('xoffset'), 10),\n            yOffset: parseInt(letters[i].getAttribute('yoffset'), 10),\n            xAdvance: parseInt(letters[i].getAttribute('xadvance'), 10),\n            kerning: {},\n            texture: new Texture(texture.baseTexture, textureRect),\n\n        };\n    }\n\n    // parse kernings\n    const kernings = resource.data.getElementsByTagName('kerning');\n\n    for (let i = 0; i < kernings.length; i++)\n    {\n        const first = parseInt(kernings[i].getAttribute('first'), 10);\n        const second = parseInt(kernings[i].getAttribute('second'), 10);\n        const amount = parseInt(kernings[i].getAttribute('amount'), 10);\n\n        if (data.chars[second])\n        {\n            data.chars[second].kerning[first] = amount;\n        }\n    }\n\n    resource.bitmapFont = data;\n\n    // I'm leaving this as a temporary fix so we can test the bitmap fonts in v3\n    // but it's very likely to change\n    BitmapText.fonts[data.font] = data;\n}\n\nexport default function ()\n{\n    return function bitmapFontParser(resource, next)\n    {\n        // skip if no data or not xml data\n        if (!resource.data || !resource.isXml)\n        {\n            next();\n\n            return;\n        }\n\n        // skip if not bitmap font data, using some silly duck-typing\n        if (resource.data.getElementsByTagName('page').length === 0\n            || resource.data.getElementsByTagName('info').length === 0\n            || resource.data.getElementsByTagName('info')[0].getAttribute('face') === null\n        )\n        {\n            next();\n\n            return;\n        }\n\n        let xmlUrl = !resource.isDataUrl ? path.dirname(resource.url) : '';\n\n        if (resource.isDataUrl)\n        {\n            if (xmlUrl === '.')\n            {\n                xmlUrl = '';\n            }\n\n            if (this.baseUrl && xmlUrl)\n            {\n                // if baseurl has a trailing slash then add one to xmlUrl so the replace works below\n                if (this.baseUrl.charAt(this.baseUrl.length - 1) === '/')\n                {\n                    xmlUrl += '/';\n                }\n\n                // remove baseUrl from xmlUrl\n                xmlUrl = xmlUrl.replace(this.baseUrl, '');\n            }\n        }\n\n        // if there is an xmlUrl now, it needs a trailing slash. Ensure that it does if the string isn't empty.\n        if (xmlUrl && xmlUrl.charAt(xmlUrl.length - 1) !== '/')\n        {\n            xmlUrl += '/';\n        }\n\n        const textureUrl = xmlUrl + resource.data.getElementsByTagName('page')[0].getAttribute('file');\n\n        if (utils.TextureCache[textureUrl])\n        {\n            // reuse existing texture\n            parse(resource, utils.TextureCache[textureUrl]);\n            next();\n        }\n        else\n        {\n            const loadOptions = {\n                crossOrigin: resource.crossOrigin,\n                loadType: Resource.LOAD_TYPE.IMAGE,\n                metadata: resource.metadata.imageMetadata,\n            };\n\n            // load the texture for the font\n            this.add(`${resource.name}_image`, textureUrl, loadOptions, (res) =>\n            {\n                parse(resource, res.texture);\n                next();\n            });\n        }\n    };\n}\n"]}