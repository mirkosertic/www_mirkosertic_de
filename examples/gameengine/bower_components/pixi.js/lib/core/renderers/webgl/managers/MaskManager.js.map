{"version":3,"sources":["../../../../../src/core/renderers/webgl/managers/MaskManager.js"],"names":["MaskManager","renderer","scissor","scissorData","scissorRenderTarget","enableScissor","alphaMaskPool","alphaMaskIndex","pushMask","target","maskData","texture","pushSpriteMask","stencilManager","stencilMaskStack","length","isFastRect","matrix","worldTransform","rot","Math","atan2","b","a","round","PI","pushStencilMask","pushScissorMask","popMask","popSpriteMask","popScissorMask","popStencilMask","alphaMaskFilter","resolution","maskSprite","filterArea","getBounds","filterManager","pushFilter","popFilter","currentRenderer","stop","pushStencil","popStencil","renderable","renderTarget","_activeRenderTarget","bounds","fit","size","gl","enable","SCISSOR_TEST","x","root","height","y","width","disable"],"mappings":"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","file":"MaskManager.js","sourcesContent":["import WebGLManager from './WebGLManager';\nimport AlphaMaskFilter from '../filters/spriteMask/SpriteMaskFilter';\n\n/**\n * @class\n * @extends PIXI.WebGLManager\n * @memberof PIXI\n */\nexport default class MaskManager extends WebGLManager\n{\n    /**\n     * @param {PIXI.WebGLRenderer} renderer - The renderer this manager works for.\n     */\n    constructor(renderer)\n    {\n        super(renderer);\n\n        // TODO - we don't need both!\n        this.scissor = false;\n        this.scissorData = null;\n        this.scissorRenderTarget = null;\n\n        this.enableScissor = true;\n\n        this.alphaMaskPool = [];\n        this.alphaMaskIndex = 0;\n    }\n\n    /**\n     * Applies the Mask and adds it to the current filter stack.\n     *\n     * @param {PIXI.DisplayObject} target - Display Object to push the mask to\n     * @param {PIXI.Sprite|PIXI.Graphics} maskData - The masking data.\n     */\n    pushMask(target, maskData)\n    {\n        if (maskData.texture)\n        {\n            this.pushSpriteMask(target, maskData);\n        }\n        else if (this.enableScissor\n            && !this.scissor\n            && !this.renderer.stencilManager.stencilMaskStack.length\n            && maskData.isFastRect())\n        {\n            const matrix = maskData.worldTransform;\n\n            let rot = Math.atan2(matrix.b, matrix.a);\n\n            // use the nearest degree!\n            rot = Math.round(rot * (180 / Math.PI));\n\n            if (rot % 90)\n            {\n                this.pushStencilMask(maskData);\n            }\n            else\n            {\n                this.pushScissorMask(target, maskData);\n            }\n        }\n        else\n        {\n            this.pushStencilMask(maskData);\n        }\n    }\n\n    /**\n     * Removes the last mask from the mask stack and doesn't return it.\n     *\n     * @param {PIXI.DisplayObject} target - Display Object to pop the mask from\n     * @param {PIXI.Sprite|PIXI.Graphics} maskData - The masking data.\n     */\n    popMask(target, maskData)\n    {\n        if (maskData.texture)\n        {\n            this.popSpriteMask(target, maskData);\n        }\n        else if (this.enableScissor && !this.renderer.stencilManager.stencilMaskStack.length)\n        {\n            this.popScissorMask(target, maskData);\n        }\n        else\n        {\n            this.popStencilMask(target, maskData);\n        }\n    }\n\n    /**\n     * Applies the Mask and adds it to the current filter stack.\n     *\n     * @param {PIXI.RenderTarget} target - Display Object to push the sprite mask to\n     * @param {PIXI.Sprite} maskData - Sprite to be used as the mask\n     */\n    pushSpriteMask(target, maskData)\n    {\n        let alphaMaskFilter = this.alphaMaskPool[this.alphaMaskIndex];\n\n        if (!alphaMaskFilter)\n        {\n            alphaMaskFilter = this.alphaMaskPool[this.alphaMaskIndex] = [new AlphaMaskFilter(maskData)];\n        }\n\n        alphaMaskFilter[0].resolution = this.renderer.resolution;\n        alphaMaskFilter[0].maskSprite = maskData;\n\n        // TODO - may cause issues!\n        target.filterArea = maskData.getBounds(true);\n\n        this.renderer.filterManager.pushFilter(target, alphaMaskFilter);\n\n        this.alphaMaskIndex++;\n    }\n\n    /**\n     * Removes the last filter from the filter stack and doesn't return it.\n     *\n     */\n    popSpriteMask()\n    {\n        this.renderer.filterManager.popFilter();\n        this.alphaMaskIndex--;\n    }\n\n    /**\n     * Applies the Mask and adds it to the current filter stack.\n     *\n     * @param {PIXI.Sprite|PIXI.Graphics} maskData - The masking data.\n     */\n    pushStencilMask(maskData)\n    {\n        this.renderer.currentRenderer.stop();\n        this.renderer.stencilManager.pushStencil(maskData);\n    }\n\n    /**\n     * Removes the last filter from the filter stack and doesn't return it.\n     *\n     */\n    popStencilMask()\n    {\n        this.renderer.currentRenderer.stop();\n        this.renderer.stencilManager.popStencil();\n    }\n\n    /**\n     *\n     * @param {PIXI.DisplayObject} target - Display Object to push the mask to\n     * @param {PIXI.Graphics} maskData - The masking data.\n     */\n    pushScissorMask(target, maskData)\n    {\n        maskData.renderable = true;\n\n        const renderTarget = this.renderer._activeRenderTarget;\n\n        const bounds = maskData.getBounds();\n\n        bounds.fit(renderTarget.size);\n        maskData.renderable = false;\n\n        this.renderer.gl.enable(this.renderer.gl.SCISSOR_TEST);\n\n        const resolution = this.renderer.resolution;\n\n        this.renderer.gl.scissor(\n            bounds.x * resolution,\n            (renderTarget.root ? renderTarget.size.height - bounds.y - bounds.height : bounds.y) * resolution,\n            bounds.width * resolution,\n            bounds.height * resolution\n        );\n\n        this.scissorRenderTarget = renderTarget;\n        this.scissorData = maskData;\n        this.scissor = true;\n    }\n\n    /**\n     *\n     *\n     */\n    popScissorMask()\n    {\n        this.scissorRenderTarget = null;\n        this.scissorData = null;\n        this.scissor = false;\n\n        // must be scissor!\n        const gl = this.renderer.gl;\n\n        gl.disable(gl.SCISSOR_TEST);\n    }\n}\n"]}