{"version":3,"sources":["../../../src/extras/webgl/TilingSpriteRenderer.js"],"names":["core","tempMat","Matrix","tempArray","Float32Array","TilingSpriteRenderer","renderer","shader","simpleShader","quad","onContextChange","gl","Shader","bindVao","Quad","state","attribState","initVao","render","ts","vao","vertices","_width","anchor","x","_height","y","uvs","upload","tex","_texture","baseTex","baseTexture","lt","tileTransform","localTransform","uv","uvTransform","isSimple","isPowerOfTwo","frame","width","height","_glTextures","CONTEXT_UID","wrapMode","CLAMP","REPEAT","bindShader","w","h","W","H","set","a","b","c","d","tx","ty","invert","append","mapCoord","uniforms","uMapCoord","toArray","uClampFrame","uClampOffset","uTransform","color","utils","hex2rgb","tint","worldAlpha","uColor","translationMatrix","transform","worldTransform","uSampler","bindTexture","setBlendMode","blendMode","draw","TRIANGLES","ObjectRenderer","WebGLRenderer","registerPlugin"],"mappings":"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","file":"TilingSpriteRenderer.js","sourcesContent":["import * as core from '../../core';\nimport { WRAP_MODES } from '../../core/const';\nimport { readFileSync } from 'fs';\nimport { join } from 'path';\n\nconst tempMat = new core.Matrix();\nconst tempArray = new Float32Array(4);\n\n/**\n * WebGL renderer plugin for tiling sprites\n */\nexport default class TilingSpriteRenderer extends core.ObjectRenderer {\n\n    /**\n     * constructor for renderer\n     *\n     * @param {WebGLRenderer} renderer The renderer this tiling awesomeness works for.\n     */\n    constructor(renderer)\n    {\n        super(renderer);\n\n        this.shader = null;\n        this.simpleShader = null;\n        this.quad = null;\n    }\n\n    /**\n     * Sets up the renderer context and necessary buffers.\n     *\n     * @private\n     */\n    onContextChange()\n    {\n        const gl = this.renderer.gl;\n\n        this.shader = new core.Shader(gl,\n            readFileSync(join(__dirname, './tilingSprite.vert'), 'utf8'),\n            readFileSync(join(__dirname, './tilingSprite.frag'), 'utf8'));\n        this.simpleShader = new core.Shader(gl,\n            readFileSync(join(__dirname, './tilingSprite.vert'), 'utf8'),\n            readFileSync(join(__dirname, './tilingSprite_simple.frag'), 'utf8'));\n\n        this.renderer.bindVao(null);\n        this.quad = new core.Quad(gl, this.renderer.state.attribState);\n        this.quad.initVao(this.shader);\n    }\n\n    /**\n     *\n     * @param {PIXI.extras.TilingSprite} ts tilingSprite to be rendered\n     */\n    render(ts)\n    {\n        const renderer = this.renderer;\n        const quad = this.quad;\n\n        renderer.bindVao(quad.vao);\n\n        let vertices = quad.vertices;\n\n        vertices[0] = vertices[6] = (ts._width) * -ts.anchor.x;\n        vertices[1] = vertices[3] = ts._height * -ts.anchor.y;\n\n        vertices[2] = vertices[4] = (ts._width) * (1.0 - ts.anchor.x);\n        vertices[5] = vertices[7] = ts._height * (1.0 - ts.anchor.y);\n\n        vertices = quad.uvs;\n\n        vertices[0] = vertices[6] = -ts.anchor.x;\n        vertices[1] = vertices[3] = -ts.anchor.y;\n\n        vertices[2] = vertices[4] = 1.0 - ts.anchor.x;\n        vertices[5] = vertices[7] = 1.0 - ts.anchor.y;\n\n        quad.upload();\n\n        const tex = ts._texture;\n        const baseTex = tex.baseTexture;\n        const lt = ts.tileTransform.localTransform;\n        const uv = ts.uvTransform;\n        let isSimple = baseTex.isPowerOfTwo\n            && tex.frame.width === baseTex.width && tex.frame.height === baseTex.height;\n\n        // auto, force repeat wrapMode for big tiling textures\n        if (isSimple)\n        {\n            if (!baseTex._glTextures[renderer.CONTEXT_UID])\n            {\n                if (baseTex.wrapMode === WRAP_MODES.CLAMP)\n                {\n                    baseTex.wrapMode = WRAP_MODES.REPEAT;\n                }\n            }\n            else\n            {\n                isSimple = baseTex.wrapMode !== WRAP_MODES.CLAMP;\n            }\n        }\n\n        const shader = isSimple ? this.simpleShader : this.shader;\n\n        renderer.bindShader(shader);\n\n        const w = tex.width;\n        const h = tex.height;\n        const W = ts._width;\n        const H = ts._height;\n\n        tempMat.set(lt.a * w / W,\n            lt.b * w / H,\n            lt.c * h / W,\n            lt.d * h / H,\n            lt.tx / W,\n            lt.ty / H);\n\n        // that part is the same as above:\n        // tempMat.identity();\n        // tempMat.scale(tex.width, tex.height);\n        // tempMat.prepend(lt);\n        // tempMat.scale(1.0 / ts._width, 1.0 / ts._height);\n\n        tempMat.invert();\n        if (isSimple)\n        {\n            tempMat.append(uv.mapCoord);\n        }\n        else\n        {\n            shader.uniforms.uMapCoord = uv.mapCoord.toArray(true);\n            shader.uniforms.uClampFrame = uv.uClampFrame;\n            shader.uniforms.uClampOffset = uv.uClampOffset;\n        }\n\n        shader.uniforms.uTransform = tempMat.toArray(true);\n\n        const color = tempArray;\n\n        core.utils.hex2rgb(ts.tint, color);\n        color[3] = ts.worldAlpha;\n        shader.uniforms.uColor = color;\n        shader.uniforms.translationMatrix = ts.transform.worldTransform.toArray(true);\n\n        shader.uniforms.uSampler = renderer.bindTexture(tex);\n\n        renderer.setBlendMode(ts.blendMode);\n\n        quad.vao.draw(this.renderer.gl.TRIANGLES, 6, 0);\n    }\n}\n\ncore.WebGLRenderer.registerPlugin('tilingSprite', TilingSpriteRenderer);\n"]}