<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Implementing a custom Query Parser for Apache Solr &middot; Mirko Sertic</title><meta name="description" content="Apache Solr is a very powerful and mature enterprise search server. It comes with a lot of handy and useful features. One of its features is the query API. This posting shows the hole process of implementing a custom query parser for Apache Solr."><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="robots" content="index,follow"><meta property="og:title" content="Implementing a custom Query Parser for Apache Solr"><meta property="og:description" content="Apache Solr is a very powerful and mature enterprise search server. It comes with a lot of handy and useful features. One of its features is the query API. This posting shows the hole process of implementing a custom query parser for Apache Solr."><meta property="og:type" content="article"><meta property="og:url" content="https://www.mirkosertic.de/blog/2017/10/custom-query-parser-for-solr/"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="https://www.mirkosertic.de/css/site.css" rel="stylesheet" media="screen"><link rel="shortcut icon" type="image/x-icon" href="https://www.mirkosertic.de/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="https://www.mirkosertic.de/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://www.mirkosertic.de/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://www.mirkosertic.de/favicon-16x16.png"><link rel="manifest" href="https://www.mirkosertic.de/manifest.json"><link rel="mask-icon" href="https://www.mirkosertic.de/safari-pinned-tab.svg" color="#5bbad5"><script src="https://polyfill.io/v2/polyfill.min.js?features=default,IntersectionObserver"></script><meta name="theme-color" content="#ffffff"><script type="application/javascript">var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-33614060-2', 'auto');
	
	ga('send', 'pageview');
}</script><script async src="https://www.google-analytics.com/analytics.js"></script></head><body itemscope itemtype="http://schema.org/WebPage"><header><nav class="navbar navbar-expand-md navbar-dark fixed-top" itemscope itemtype="http://www.schema.org/SiteNavigationElement"><div class="container"><a class="navbar-brand" href="https://www.mirkosertic.de/">www.mirkosertic.de</a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav mr-auto"><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/toolsgoodies" title="Tools &amp; Goodies">Tools &amp; Goodies</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/interestingbooks" title="Interesting Books">Interesting Books</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/favorites" title="My favorite postings">My favorite postings</a></li><li class="nav-item"><a itemprop="url" class="nav-link active" href="/post/" title="Blog">Blog</a></li></ul></div></div></nav></header><main role="main"><div itemprop="mainEntity" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Implementing a custom Query Parser for Apache Solr</h1><p class="post-date"><span class="icon"><i class="fa fa-calendar-check-o-white"></i></span><time datetime="2017-10-26" itemprop="datePublished">Thu, Oct 26, 2017</time> <span>by</span> <span itemprop="author" itemscope="" itemtype="https://schema.org/Person"><span itemprop="name"><a href="https://twitter.com/mirkosertic" itemprop="url" rel="author">Mirko Sertic</a></span></span></p><p><span class="icon"><i class="fa fa-clock-white"></i></span><span>4 Minutes reading time</span></p><p class="post-tags"><span class="tag"><span class="icon"><i class="fa fa-tags-white"></i></span><a href="/tags/enterprise">Enterprise</a></span> ,&nbsp;<a href="/tags/interesting">Interesting</a> ,&nbsp;<a href="/tags/search">Search</a></p></header><article class="post-content clearfix" itemprop="articleBody"><div class="paragraph"><p>Apache Solr is a very powerful and mature enterprise search server. It comes with a lot of handy and useful features. One of its features is the query API.</p></div><div class="paragraph"><p>Now, what is the query API? This API is used to search thru the indexed documents, as the name suggests. But how are the documents searched? Well, the search is based on a search query. Basically the search query is a string, and this string is passed to a so called query parser. The query parser then transforms the query string to a Lucene query instance, which is then used by Solr to crawl the index and return found documents.</p></div><div class="paragraph"><p>Apache Solr comes with a default query parser which supports the Lucene query syntax. There are also some more advanced query parser available, and a plugin API so implement a custom query parser. Now I want to take a look at the plugin API to implement a custom query parser and configure Solr to use it.</p></div><div class="sect1"><h2 id="_solr_plugin_implementation">Solr plugin implementation</h2><div class="sectionbody"><div class="paragraph"><p>What should the new query parser do? Well, it should transform a simple user entered phrase to a more advanced Lucene query, which does the following:</p></div><div class="paragraph"><p>Search string is : domain driven design</p></div><div class="paragraph"><p>Generated Lucene query in prose would be:</p></div><div class="dlist"><dl><dt class="hdlist1">Highest raking</dt><dd><p>exact match of terms &#34;domain&#34; and &#34;driven&#34; and &#34;design&#34; is this order</p></dd><dt class="hdlist1">A little bit lower ranking</dt><dd><p>terms &#34;domain&#34; and &#34;driven&#34; and &#34;design&#34; with a slop of one and in any order</p></dd><dt class="hdlist1">Even lower ranking</dt><dd><p>terms &#34;domain&#34; and &#34;driven&#34; and &#34;design&#34; with a slop of two and in any order</p></dd><dt class="hdlist1">Lowest ranking</dt><dd><p>existence of the terms &#34;domain&#34; and &#34;driven&#34; and &#34;design&#34; at any place in the document in any order</p></dd></dl></div><div class="paragraph"><p>Where would we start to implement such a query parser? Well, we start with the Solr query parser plugin. And for starters, here is the annotated source code for our new plugin:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">package de.mirkosertic.desktopsearch;

import org.apache.lucene.search.Query;
import org.apache.solr.common.params.SolrParams;
import org.apache.solr.common.util.NamedList;
import org.apache.solr.request.SolrQueryRequest;
import org.apache.solr.schema.IndexSchema;
import org.apache.solr.search.QParser;
import org.apache.solr.search.QParserPlugin;
import org.apache.solr.search.SyntaxError;

public class QueryParserPlugin extends QParserPlugin { <i class="conum" data-value="1"></i><b>(1)</b>

    @Override
    public void init(NamedList args) { <i class="conum" data-value="2"></i><b>(2)</b>
        super.init(args);
    }

    @Override
    public QParser createParser(String aQueryString, SolrParams aLocalParams, SolrParams aParams, SolrQueryRequest aRequest) { <i class="conum" data-value="3"></i><b>(3)</b>
        return new QParser(aQueryString, aLocalParams, aParams, aRequest) {
            @Override
            public Query parse() throws SyntaxError { <i class="conum" data-value="4"></i><b>(4)</b>
                IndexSchema theSchema = aRequest.getSchema();

                return ... <i class="conum" data-value="5"></i><b>(5)</b>
            }
        };
    }
}</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>Every custom query parser must extend the org.apache.solr.search.QParserPlugin class</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>The init method is called once after Solr has instantiated the class</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>This method is called for every search request to retrieve a new org.apache.solr.search.QParser instance</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>The parse Method is invoked by Solr for every search request</td></tr><tr><td><i class="conum" data-value="5"></i><b>5</b></td><td>Here happens the magic to transform a query string into a Lucene org.apache.lucene.search.Query instance</td></tr></tbody></table></div></div></div><div class="sect1"><h2 id="_solr_configuration">Solr configuration</h2><div class="sectionbody"><div class="paragraph"><p>Now we need to configure Solr to make the plugin available. Part of the configuration is to build a JAR file with all of the plugin dependencies and add it to the Solr Core classpath. Then we need to register the plugin in the solrconfig.xml file as follows:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-xml" data-lang="xml">&lt;queryParser
    name=&#34;customqueryparser&#34;  <i class="conum" data-value="1"></i><b>(1)</b>
    class=&#34;de.mirkosertic.desktopsearch.QueryParserPlugin&#34; <i class="conum" data-value="2"></i><b>(2)</b>
    /&gt;</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>A unique name for the query parser plugin</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>The full qualified classname of the query parser plugin</td></tr></tbody></table></div></div></div><div class="sect1"><h2 id="_it_is_query_time">It is query time!</h2><div class="sectionbody"><div class="paragraph"><p>Finally we can fire a search query to Solr. To use our new query parser for this query, we have to add a <strong>defType=customqueryparser</strong> to the search request. The passed value matches the name attribute of the added queryParser element in solrconfig.xml.</p></div></div></div><div class="sect1"><h2 id="_details_ive_missed">Details I’ve missed</h2><div class="sectionbody"><div class="paragraph"><p>You will have noticed that I’ve left out the complete query parser implementation. Under the hood I am using a Lucene Boolean Query with a lot of nesting SpanNear and TermQueries. Showing the hole process would be too much at this point, as I am focusing on the Solr plugin API here. If you want to dive deeper into the Lucene query construction process, I’d suggest to take a look at my JavaFX Desktop Search Project hosted at <a href="https://github.com/mirkosertic/FXDesktopSearch">GitHub</a>.</p></div></div></div><div class="metainfo"><span>&lt;&lt;Pevious posting: <a href="https://www.mirkosertic.de/blog/2017/06/compiling-bytecode-to-javascript/">Bytecoder : A Low Level Bytecode to JavaScript Transpiler</a></span> <span>Next posting: <a href="https://www.mirkosertic.de/blog/2018/01/object-oriented-webassembly/">Object-Oriented WebAssembly</a>&gt;&gt;</span></div><p><i class="fa fa-github"></i>Git revision: <a href="https://github.com/mirkosertic/www_mirkosertic_de/commit/645d26567af7d9ba972fb0fb33fc4d4cd20ab01c" target="_blank">645d265</a></p></article></div><div class="comments"><div id="disqus-placeholder">Loading comments...</div><div id="disqus_thread"></div><script>'use strict';
        window.addEventListener("load", function(event) {
            var disqusLoaded = false;
            var disqusObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (!disqusLoaded && entry.isIntersecting) {
                        console.log("Loading Disqus");
                        disqusLoaded = true;

                        document.getElementById('disqus-placeholder').remove();

                        
                        var script = document.createElement('script');
                        script.src = '//www-mirkosertic-de.disqus.com/embed.js';
                        script.async = true;
                        script.setAttribute('data-timestamp', +new Date());
                        script.addEventListener('load', function () {
                            
                            DISQUS.reset({reload: true, config: false});
                        });
                        (document.head || document.body).appendChild(script);
                    }
                });
            }, {
                root: null,
                rootMargin: "0px",
                threshold: [0]
            });
            disqusObserver.observe(document.querySelector(".comments"));
        }, false);</script></div></main><footer><p>&copy; Mirko Sertic &middot; <a href="https://www.mirkosertic.de/global/impressum/index.html">Imprint / Impressum</a></p><address><strong itemprop="name">Mirko Sertic</strong><div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"><div itemprop="streetAddress">Josefine-Mauser-Str. 66</div><div itemprop="postalCode">48157 Münster</div><div itemprop="addressCountry">Germany</div></div><a class="icon" target="_top" href="mailto:mirko@mirkosertic.de"><i class="fa fa-envelope-white"></i></a> <a class="icon" target="_blank" href="https://www.mirkosertic.de/index.xml" itemprop="url"><i class="fa fa-rss-white"></i></a> <a class="icon" target="_blank" href="https://www.xing.com/profile/Mirko_Sertic" itemprop="url"><i class="fa fa-xing-white"></i></a> <a class="icon" target="_blank" href="https://twitter.com/mirkosertic" itemprop="url"><i class="fa fa-twitter-white"></i></a> <a class="icon" target="_blank" href="https://github.com/mirkosertic" itemprop="url"><i class="fa fa-github-white"></i></a> <a class="icon" target="_blank" href="https://de.linkedin.com/in/mirko-sertic-98882397" itemprop="url"><i class="fa fa-linkedin-white"></i></a></address><p class="float-right"><a href="#">Back to top</a></p></footer><script src="https://www.mirkosertic.de/js/bootstrap-native-v4.min.js"></script><script>function existsByCSSSelector(aSelector) {
        var element = document.querySelector(aSelector);
        if (element) {
            return true;
        }
        return false;
    }

    var Loader = function () { };
    Loader.prototype = {
        require: function (scripts, callback) {
            this.loadCount = 0;
            this.totalRequired = scripts.length;
            this.callback = callback;

            for (var i=0;i<scripts.length;i++) {
                this.writeScript(scripts[i]);
            }
        },
        loaded: function (evt) {
            this.loadCount++;

            if (this.loadCount==this.totalRequired && typeof this.callback=='function') this.callback.call();
        },
        writeScript: function (src) {
            var self = this;
            var s = document.createElement('script');
            s.type = "text/javascript";
            s.async = true;
            s.src = src;
            s.addEventListener('load', function (e) { self.loaded(e); }, false);
            var head = document.getElementsByTagName('head')[0];
            head.appendChild(s);
        }
    };

    if (existsByCSSSelector("pre.highlight code") > 0) {
        var loader = new Loader();
        loader.require(["https:\/\/www.mirkosertic.de\/js/highlight-9.9.0.min.js"], function() {

            var additionalStylesheet = document.createElement('link');
            additionalStylesheet.rel = "stylesheet";
            additionalStylesheet.type = 'text/css';
            additionalStylesheet.media = "screen";
            additionalStylesheet.href = "https:\/\/www.mirkosertic.de\/css/highlight.css";

            var head = document.getElementsByTagName('head')[0];
            head.appendChild(additionalStylesheet);

            hljs.initHighlightingOnLoad();
        });
    }</script></body></html>