<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Object-Oriented WebAssembly &middot; Mirko Sertic</title><meta name="description" content="Today, I want to write a little bit about object orientation and WebAssembly. For starters, what is WebAssembly? WebAssembly is a new portable, size and load-time efficient format suitable for compilation to the web. It is an open standard by a W3C community group and is currently integrated into all major browsers such as Firefox, Chrome, Edge and WebKit. WebAssembly aims to keep download speed and parsing time of program code low and execute at native speed by taking advance of common hardware capabilities available on a wide range of platforms. WebAssembly is basically bytecode for the Web."><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="robots" content="index,follow"><meta property="og:title" content="Object-Oriented WebAssembly"><meta property="og:description" content="Today, I want to write a little bit about object orientation and WebAssembly. For starters, what is WebAssembly? WebAssembly is a new portable, size and load-time efficient format suitable for compilation to the web. It is an open standard by a W3C community group and is currently integrated into all major browsers such as Firefox, Chrome, Edge and WebKit. WebAssembly aims to keep download speed and parsing time of program code low and execute at native speed by taking advance of common hardware capabilities available on a wide range of platforms. WebAssembly is basically bytecode for the Web."><meta property="og:type" content="article"><meta property="og:url" content="https://www.mirkosertic.de/blog/2018/01/object-oriented-webassembly/"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="https://www.mirkosertic.de/css/site.css" rel="stylesheet" media="screen"><link rel="shortcut icon" type="image/x-icon" href="https://www.mirkosertic.de/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="https://www.mirkosertic.de/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://www.mirkosertic.de/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://www.mirkosertic.de/favicon-16x16.png"><link rel="manifest" href="https://www.mirkosertic.de/manifest.json"><link rel="mask-icon" href="https://www.mirkosertic.de/safari-pinned-tab.svg" color="#5bbad5"><script src="https://polyfill.io/v2/polyfill.min.js?features=default,IntersectionObserver"></script><meta name="theme-color" content="#ffffff"><script>var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-33614060-2', 'auto');
	
	ga('send', 'pageview');
}</script><script async src="https://www.google-analytics.com/analytics.js"></script></head><body itemscope itemtype="http://schema.org/WebPage"><header><nav class="navbar navbar-expand-md navbar-dark fixed-top" itemscope itemtype="http://www.schema.org/SiteNavigationElement"><div class="container"><a class="navbar-brand" href="https://www.mirkosertic.de/">www.mirkosertic.de</a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav mr-auto"><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/toolsgoodies" title="Tools &amp; Goodies">Tools &amp; Goodies</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/interestingbooks" title="Interesting Books">Interesting Books</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/favorites" title="My favorite postings">My favorite postings</a></li><li class="nav-item"><a itemprop="url" class="nav-link active" href="/post/" title="Blog">Blog</a></li></ul></div></div></nav></header><main role="main"><div itemprop="mainEntity" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Object-Oriented WebAssembly</h1><p class="post-date"><span class="icon"><i class="fa fa-calendar-check-o-white"></i></span><time datetime="2018-01-01" itemprop="datePublished">Mon, Jan 1, 2018</time> <span>by</span> <span itemprop="author" itemscope="" itemtype="https://schema.org/Person"><span itemprop="name"><a href="https://twitter.com/mirkosertic" itemprop="url" rel="author">Mirko Sertic</a></span></span></p><p><span class="icon"><i class="fa fa-clock-white"></i></span><span>13 Minutes reading time</span></p><p class="post-tags"><span class="tag"><span class="icon"><i class="fa fa-tags-white"></i></span><a href="/tags/compiler">Compiler</a></span> ,&nbsp;<a href="/tags/interesting">Interesting</a> ,&nbsp;<a href="/tags/performance">Performance</a> ,&nbsp;<a href="/tags/javascript">JavaScript</a> ,&nbsp;<a href="/tags/html5">HTML5</a> ,&nbsp;<a href="/tags/web">Web</a> ,&nbsp;<a href="/tags/webassembly">WebAssembly</a></p></header><article class="post-content clearfix" itemprop="articleBody"><div class="paragraph"><p>Today, I want to write a little bit about object orientation and WebAssembly. For starters, what is WebAssembly? WebAssembly is a new portable, size and load-time efficient format suitable for compilation to the web. It is an open standard by a W3C community group and is currently integrated into all major browsers such as Firefox, Chrome, Edge and WebKit. WebAssembly aims to keep download speed and parsing time of program code low and execute at native speed by taking advance of common hardware capabilities available on a wide range of platforms. WebAssembly is basically bytecode for the Web.</p></div><div class="paragraph"><p>As you might have noticed, WebAssembly is a very low level language, very next to the hardware. It is meant to be a compile target for high level languages such as C++ or Java. You can if course write WebAssembly by yourself. For this purpose, WebAssembly comes in two flavours of code, a binary representation which is meant to be distributed, and a textual representation, which is meant for debugging in a human readable form.</p></div><div class="paragraph"><p>WebAssembly has a very reduced set of data types available. Version 1.0 as it is currently implemented in all browsers supports four! data types, which are:</p></div><div class="ulist"><ul><li><p>i32 and i64 classify 32 and 64 bit integers, respectively. Integers are not inherently signed or unsigned, their interpretation is determined by individual operations.</p></li><li><p>f32 and f64 classify 32 and 64 bit floating-point data, respectively. They correspond to the respective binary floating-point representations, also known as single and double precision, as defined by the IEEE 754-2008 standard (Section 3.3).</p></li></ul></div><div class="paragraph"><p>Beside the limited set of data types available, WebAssembly also does not have support high level language structures such as arrays, structs and classes.</p></div><div class="paragraph"><p>Given all these limitations, how could a compiler translate a high level language into such a efficient, but low level format? Now I want to show you an example how I did this in my <a href="https://www.mirkosertic.de/blog/2017/06/compiling-bytecode-to-javascript/">Bytecoder</a> transpiler!</p></div><div class="sect1"><h2 id="_say_hello_world_by_doing_some_calculus">Say hello world by doing some calculus</h2><div class="sectionbody"><div class="paragraph"><p>Lets start with a very simple example. A class with a main method doing some very simple calculus. We have the following Java code:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">public class HelloWorld {

    public static int compute() {
        int a = 10;
        int b = 20;
        return a + b;
    }

    public static void main(String[] args) {
        int result = compute();
    }
}</code></pre></div></div><div class="paragraph"><p>How, lets take a look at the compile result in its WebAssembly textual representation with added comments by myself:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>   ;;
   ;; Here we are doing some computation by adding two integers and returning them.
   ;;
   (func $HelloWorld_INTcompute (param $UNUSED i32) (result i32) <i class="conum" data-value="1"></i><b>(1)</b>
         (local $var0 i32)  <i class="conum" data-value="2"></i><b>(2)</b>
         (local $var1 i32)
         (set_local $var0
             (i32.const 10)
         )
         (set_local $var1
             (i32.const 20)
         )
         (return
             (i32.add     <i class="conum" data-value="3"></i><b>(3)</b>
                 (get_local $var0)
                 (get_local $var1)
             )

         )
   )

   ;;
   ;; This is the original main method, which basically just calls the static compute method
   ;;
   (func $HelloWorld_VOIDmainA1TString (param $UNUSED i32) (param $p1 i32) <i class="conum" data-value="4"></i><b>(4)</b>
         (local $var0 i32)
         (set_local $var0
             (call $HelloWorld_INTcompute (i32.const 0))
         )
         (return)
   )</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>This is an example how static methods are translated into WebAssembly functions. Function names are derived from the class name and the function name including the full method signature to avoid naming conflicts in case of method overloading. Every method and also constructors or class initializers are compiled into such functions.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>Here we see some local variables needed for computation. Every variable must be declared at the beginning. WebAssembly does not have scoping rules for variables. They are visible for the whole function body.</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>This shows a simple add operation and returning its value.</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>Another static method. I will come to the exact rules later in this post.</td></tr></tbody></table></div></div></div><div class="sect1"><h2 id="_diving_deeper_into_the_rabbit_hole">Diving deeper into the rabbit hole</h2><div class="sectionbody"><div class="paragraph"><p>That seems to be quite easy, We can clearly see the low-level nature of WebAssembly, but we can also see that it is possible to compile high level language code into this format. But there is some subtle magic used to make this possible. Lets take a look!</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>(func $HelloWorld_INTcompute (param $UNUSED i32) (result i32) <i class="conum" data-value="1"></i><b>(1)</b>
(func $HelloWorld_VOIDmainA1TString (param $UNUSED i32) (param $p1 i32) <i class="conum" data-value="2"></i><b>(2)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>There is an $UNUSED function argument! Basically, every function needs a context, its owning object. As static methods do not have an owning context, this argument is unused, as the name suggests. Of course we could leave this out, but I will show you why this is needed to implement high level structures such as lambdas later.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>The original main method take an array reference as an input, but this is mapped to an int32 data type? Why? Because references are basically pointers to an allocated memory area. All references are mapped to an int32 pointer in WebAssembly output!</td></tr></tbody></table></div></div></div><div class="sect1"><h2 id="_more_objects_to_come">More objects to come</h2><div class="sectionbody"><div class="paragraph"><p>Now, what if we instantiate an object and call methods on it? Given the following Java class, what would be the WebAssembly output?</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">public class HelloWorld {

    public int compute() {
        int a = 10;
        int b = 20;
        return a + b;
    }

    public static void main(String[] args) {
        HelloWorld world = new HelloWorld();
        int result = world.compute();
    }
}</code></pre></div></div><div class="paragraph"><p>Here we go:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>   ;;
   ;; This is the constructor of the Object class
   ;;
   (func $TObject_VOIDinit (param $thisRef i32) <i class="conum" data-value="1"></i><b>(1)</b>
         (return)
   )

   ;;
   ;; This is the constructor of the HelloWorld class
   ;;
   (func $HelloWorld_VOIDinit (param $thisRef i32)
         (call $TObject_VOIDinit (get_local $thisRef)) <i class="conum" data-value="2"></i><b>(2)</b>
         (return)
   )

   ;;
   ;; Now we have an instance method, ho ho ho :-)
   ;;
   (func $HelloWorld_INTcompute (param $thisRef i32) (result i32) <i class="conum" data-value="3"></i><b>(3)</b>
         (local $var0 i32) ;; INT
         (local $var1 i32) ;; INT
         (set_local $var0
             (i32.const 10)
         )
         (set_local $var1
             (i32.const 20)
         )
         (return
             (i32.add
                 (get_local $var0)
                 (get_local $var1)
             )
         )
   )

   ;;
   ;; The main method
   ;;
   (func $HelloWorld_VOIDmainA1TString (param $UNUSED i32) (param $p1 i32)
         (local $var0 i32) ;; INT
         (local $var1 i32) ;; INT

         (set_local $var0 <i class="conum" data-value="4"></i><b>(4)</b>
             (call $MemoryManager_AddressnewObjectINTINTINT
                (i32.const 0)
                (i32.const 8)
                (get_global $HelloWorld__runtimeClass)
                (i32.const 48))
         )
         (call $HelloWorld_VOIDinit (get_local $var0)) <i class="conum" data-value="5"></i><b>(5)</b>

         (set_local $var1
             (call $HelloWorld_INTcompute (get_local $var0)) <i class="conum" data-value="6"></i><b>(6)</b>
         )
         (return)
   )</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>Here we see an example of a compiled constructor. It only takes one argument, the pointer to the allocated memory area.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>Here we see the implicit super() call, a Java specific language feature.</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>This is same code as the static version of compute. There is only one difference. There is no more $UNUSED argument, now we have $thisRef, which is basically the same as the this reference in Java.</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>Ok, this is heavy. It is a new operation, which allocates a given amount of memory from the WebAssembly linear memory. We will take a look at memory management later.</td></tr><tr><td><i class="conum" data-value="5"></i><b>5</b></td><td>Here we invoke the object constructor, which fills the allocated memory with life. We can see that the new operation and constructor invocation are different steps.</td></tr><tr><td><i class="conum" data-value="6"></i><b>6</b></td><td>Here we call the compute method. Now we pass in the reference to the allocated and constructed object.</td></tr></tbody></table></div></div></div><div class="sect1"><h2 id="_virtual_function_tables">Virtual function tables</h2><div class="sectionbody"><div class="paragraph"><p>So far, we have seen classes, instances and methods. Now, what happens if we override methods in a subclass? How can we handle something like this in WebAssembly? Compilers build so called virtual function tables to perform a lookup to find the right method for a given object instance. WebAssembly itself has the concept of tables, where we can assign an index with a function pointer. Ok, but how do we do the method lookup? Lets take a look at the WebAssembly code:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>   (table 67 anyfunc)
   ;; left out for clarity
   (elem (i32.const 48) $HelloWorld__resolvevtableindex) <i class="conum" data-value="1"></i><b>(1)</b>
   (elem (i32.const 52) $HelloWorld_INTcompute) <i class="conum" data-value="2"></i><b>(2)</b>
   ;; left out for clarity</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>This is the hidden ingredient, we hide the method lookup inside a function, which can be called. It has index 48.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>This is the reference to the implementation of the compute method in the HelloWorld class. It has index 52.</td></tr></tbody></table></div><div class="paragraph"><p>So what does our $HelloWorld__resolvevtableindex method do? We dive deeper:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>   (func $HelloWorld__resolvevtableindex (param $thisRef i32) (param $p1 i32) (result i32) <i class="conum" data-value="1"></i><b>(1)</b>
         (block $b
             (br_if $b (i32.ne (get_local $p1) (i32.const 3)))  <i class="conum" data-value="2"></i><b>(2)</b>
             (return (i32.const 52)) <i class="conum" data-value="3"></i><b>(3)</b>
         )
         (unreachable)
   )</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>We have as inputs $thisRef as the object reference and $p1, which is the id of the method to be resolved.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>If method id is 3, we return index 52, which is the pointer to the $HelloWorld_INTcompute method as seen in the virtual function table. The method ids are assigned at compile time. Every method with the same name and signature gets the same id for itself and all its overridden variants.</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>52 is the index to $HelloWorld_INTcompute.</td></tr></tbody></table></div><div class="paragraph"><p>Ok, we can now lookup for a method implementation. How is this combined with a method call? We take a look at the main method in out HelloWorld example, but now we do an indirect call using the virtual function table:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>   (type $t_INT_THISREF (func (param i32) (result i32))) <i class="conum" data-value="1"></i><b>(1)</b>
   (type $t_RESOLVEMETHOD (func (param i32) (param i32) (result i32)))

   (func $HelloWorld_VOIDmainA1TString (param $UNUSED i32) (param $p1 i32)
         (local $var0 i32) ;; INT
         (local $var1 i32) ;; INT

         (set_local $var0 <i class="conum" data-value="2"></i><b>(2)</b>
             (call $MemoryManager_AddressnewObjectINTINTINT
                (i32.const 0)
                (i32.const 8)
                (get_global $HelloWorld__runtimeClass)
                (i32.const 48))
         )

         (call $HelloWorld_VOIDinit (get_local $var0)) <i class="conum" data-value="3"></i><b>(3)</b>

         (set_local $var1
             (call_indirect $t_INT_THISREF  <i class="conum" data-value="4"></i><b>(4)</b>
                 (get_local $var0)
                 (call_indirect $t_RESOLVEMETHOD <i class="conum" data-value="5"></i><b>(5)</b>
                     (get_local $var0)
                     (i32.const 3) <i class="conum" data-value="6"></i><b>(6)</b>
                     (i32.load offset=4 (get_local $var0)) <i class="conum" data-value="7"></i><b>(7)</b>
                 )
             )
         )
         (return)
   )</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>For the WebAssembly call indirect functionality, we need typed function signatures. They are declared here. We basically need two types, one for the virtual function table resolve function and a second one for the implementation method itself.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>Our memory allocation</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>Constructor invocation as usual</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>Now it is getting interesting, we are calling a method of type $t_INT_THISREF, which takes $var0 as an argument(thisref), But we need also an index into the table to get the right function pointer. This index is resolved using the second call_indirect</td></tr><tr><td><i class="conum" data-value="5"></i><b>5</b></td><td>Here we are resolving the function index by calling the resolvevtableindex function for our newly created object</td></tr><tr><td><i class="conum" data-value="6"></i><b>6</b></td><td>We are trying to find the implementation for method id 3</td></tr><tr><td><i class="conum" data-value="7"></i><b>7</b></td><td>The resolvevtableindex for a given object is stored in the allocated object for this object. Here it is stored at offset=4</td></tr></tbody></table></div><div class="paragraph"><p>Interestingly, we are storing the index of the resolvevtableindex function for every object inside of the allocated memory for this object. So we have to pass in the right index at allocation time. We take a look at the memory allocation:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>(call $MemoryManager_AddressnewObjectINTINTINT
    (i32.const 0) <i class="conum" data-value="1"></i><b>(1)</b>
    (i32.const 8)  <i class="conum" data-value="2"></i><b>(2)</b>
    (get_global $HelloWorld__runtimeClass) <i class="conum" data-value="3"></i><b>(3)</b>
    (i32.const 48)) <i class="conum" data-value="4"></i><b>(4)</b></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>This is a static method, so this is the $UNUSED argument, which defaults to 0.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>This is the size of the object. It has no fields, but a header of 8 bytes. So we allocated 8 bytes here.</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>This is the type of the object. Types are our RuntimeClasses. RuntimeClasses are stored in global variables.</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>This is the index of the virtual function resolver function, which is 48 as seen above.</td></tr></tbody></table></div></div></div><div class="sect1"><h2 id="_memory_management">Memory management</h2><div class="sectionbody"><div class="paragraph"><p>WebAssembly has a linear memory, which is sandboxed and can be freely accessed from WebAssembly as long as we keep the memory limits in mind. For our HelloWorld example, we need some kind of memory layout for the generated objects and other data that must be store during computation. We have to divide the linear memory into areas, which are basically a reserved area used by the memory manager and other runtime code, a Heap which hosts all allocated objects, and a Stack, which keeps local variables for every method invocation. There is a reasoning for keeping these areas distinguish. The heap can be very fragmented, as new objects are created or destroyed. On the other side, the Stack grows at precomputed rates which are determined at compile time. The compiler knows the exact number of local variables. Also the stack cannot fragment, as it is a FILO stack.</p></div><div class="imageblock kroki"><div class="content"><img src="/media/memorylayout-c9bf210f651353864c6791f86331d0ddb711fe2a.svg" alt="memorylayout"></div></div><div class="paragraph"><p>Now comes a limitation of the current WebAssembly specification: there is no memory manager! We have to do everything by hand. Even the garbage collector! Adding garbage collection is planned by the community group, but for now we have to implement a memory manager including a simple Mark-And-Sweep garbage collector. This is done by runtime classes which are included in the <a href="https://www.mirkosertic.de/blog/2017/06/compiling-bytecode-to-javascript/">Bytecoder</a> project. There are some tiny difficult bits here. First of all, why do we need a stack? There are local variables, why do I need an additional area in the linear memory? Well, for efficient garbage collection, the GC must crawl the Heap for dead objects, but this would also include newly created objects which are stored in local variables what are not used elsewhere. For security reasons, where is no way to introspect all live local variables in WebAssembly. To get around this issue, Bytecoder keeps primitive data types such as int and long in local variables, and but all variables of type reference on the stack and are visible to the garbage collector. Maybe I will write a second post about this topic later.</p></div></div></div><div class="sect1"><h2 id="_accessing_objects">Accessing objects</h2><div class="sectionbody"><div class="paragraph"><p>Now, we can create new objects by allocating memory from the WebAssembly linear memory. How can we access those objects? Reading and writing to object fields is just simple memory access. We know the reference of the object, so we have a pointer to its allocated linear memory segment. We just need to assign a memory offset to every field of the object. This assignment can be done at compile time. Every instance field gets its own offset.</p></div><div class="paragraph"><p>But what about static fields? Well, static fields are mapped as fields of a RuntimeClass. RuntimeClasses are global singletons, so they are a great place to store static data!</p></div><div class="paragraph"><p>Arrays are a different beast. They are basically object instances, but their length cannot determined at compile time in every case. This dynamic nature is mapped to two components. A member attribute storing the actual length of the array instance, and a data attribute which stores the data for every array element. Since we can determine the exact size of a single typed array element at compile time, we just have to consider the variable length at runtime.</p></div><div class="paragraph"><p>Here is an annotated example of a simple field access:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">public class InstanceAccessTest {

    public static class StaticClassWithStuffInside {

        public int member;
    }

    @Test
    public void testInstanceGetAndSet() {
        StaticClassWithStuffInside theInstance = new StaticClassWithStuffInside();
        theInstance.member = 12;
    }
}</code></pre></div></div><div class="paragraph"><p>Written in WebAssembly:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>(func $InstanceAccessTest_VOIDtestInstanceGetAndSet (param $thisRef i32)
     (local $SP i32)
     (local $OLD_SP i32)
     (set_local $OLD_SP (get_global $STACKTOP))
     (set_global $STACKTOP (i32.sub (get_global $STACKTOP) (i32.const 4))) <i class="conum" data-value="1"></i><b>(1)</b>
     (set_local $SP (get_global $STACKTOP))

     (i32.store offset=0 (get_local $SP)
         (call $MemoryManager_AddressnewObjectINTINTINT
            (i32.const 0)
            (i32.const 12)
            (get_global $InstanceAccessTest$StaticClassWithStuffInside__runtimeClass)
            (i32.const 33))   <i class="conum" data-value="2"></i><b>(2)</b>
     )
     (call $InstanceAccessTest$StaticClassWithStuffInside_VOIDinit
        (i32.load offset=0 (get_local $SP))) <i class="conum" data-value="3"></i><b>(3)</b>

     (i32.store offset=8 <i class="conum" data-value="4"></i><b>(4)</b>
         (i32.load offset=0 (get_local $SP)) <i class="conum" data-value="5"></i><b>(5)</b>
         (i32.const 12) <i class="conum" data-value="6"></i><b>(6)</b>
     )

     (set_global $STACKTOP (get_local $OLD_SP))
     (return)
)</code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class="conum" data-value="1"></i><b>1</b></td><td>This reserves a place on the stack for a local object reference.</td></tr><tr><td><i class="conum" data-value="2"></i><b>2</b></td><td>Memory allocation as seen before.</td></tr><tr><td><i class="conum" data-value="3"></i><b>3</b></td><td>Constructor invocation, also nothing new now.</td></tr><tr><td><i class="conum" data-value="4"></i><b>4</b></td><td>offset=8 is computed at compile time referencing the field offset.</td></tr><tr><td><i class="conum" data-value="5"></i><b>5</b></td><td>We reference the instance using the stack.</td></tr><tr><td><i class="conum" data-value="6"></i><b>6</b></td><td>We store the integer constant 12 in the instance field.</td></tr></tbody></table></div></div></div><div class="sect1"><h2 id="_finalization_and_things_i_have_left_out">Finalization and things I have left out</h2><div class="sectionbody"><div class="paragraph"><p>There are a lot of other features in modern high level programming languages available such as Enums, Exception handling, Lambda expressions or Reflections. Their implementation is far beyond the scope of this short WebAssembly introduction. If you want to dive deeper into how they can or cannot be implemented in WebAssembly, I suggest to take a look at my <a href="https://www.mirkosertic.de/blog/2017/06/compiling-bytecode-to-javascript/">Bytecoder</a> transpiler.</p></div><div class="paragraph"><p>For now, I just have to say: thank your for reading!</p></div></div></div><div class="metainfo"><span>&lt;&lt;Pevious posting: <a href="https://www.mirkosertic.de/blog/2017/10/custom-query-parser-for-solr/">Implementing a custom Query Parser for Apache Solr</a></span> <span>Next posting: <a href="https://www.mirkosertic.de/blog/2018/02/alicebobcaroldaveopencl/">Alice, Bob, Carol and Dave OpenCL Edition</a>&gt;&gt;</span></div><p><i class="fa fa-github"></i>Git revision: <a href="https://github.com/mirkosertic/www_mirkosertic_de/commit/cc979591072921fa5ff02e922b96e4c4f4af8d50" target="_blank">cc97959</a></p></article></div><div class="comments"><div id="disqus-placeholder">Loading comments...</div><div id="disqus_thread"></div><script>'use strict';
        window.addEventListener("load", function(event) {
            var disqusLoaded = false;
            var disqusObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (!disqusLoaded && entry.isIntersecting) {
                        console.log("Loading Disqus");
                        disqusLoaded = true;

                        document.getElementById('disqus-placeholder').remove();

                        
                        var script = document.createElement('script');
                        script.src = '//www-mirkosertic-de.disqus.com/embed.js';
                        script.async = true;
                        script.setAttribute('data-timestamp', +new Date());
                        script.addEventListener('load', function () {
                            
                            DISQUS.reset({reload: true, config: false});
                        });
                        (document.head || document.body).appendChild(script);
                    }
                });
            }, {
                root: null,
                rootMargin: "0px",
                threshold: [0]
            });
            disqusObserver.observe(document.querySelector(".comments"));
        }, false);</script></div></main><footer><p>&copy; Mirko Sertic &middot; <a href="https://www.mirkosertic.de/global/impressum/index.html">Imprint / Impressum</a></p><address><strong itemprop="name">Mirko Sertic</strong><div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"><div itemprop="streetAddress">Josefine-Mauser-Str. 66</div><div itemprop="postalCode">48157 Münster</div><div itemprop="addressCountry">Germany</div></div><a class="icon" target="_top" href="mailto:mirko@mirkosertic.de"><i class="fa fa-envelope-white"></i></a> <a class="icon" target="_blank" href="https://www.mirkosertic.de/index.xml" itemprop="url"><i class="fa fa-rss-white"></i></a> <a class="icon" target="_blank" href="https://www.xing.com/profile/Mirko_Sertic" itemprop="url"><i class="fa fa-xing-white"></i></a> <a class="icon" target="_blank" href="https://twitter.com/mirkosertic" itemprop="url"><i class="fa fa-twitter-white"></i></a> <a class="icon" target="_blank" href="https://github.com/mirkosertic" itemprop="url"><i class="fa fa-github-white"></i></a> <a class="icon" target="_blank" href="https://de.linkedin.com/in/mirko-sertic-98882397" itemprop="url"><i class="fa fa-linkedin-white"></i></a></address><p class="float-right"><a href="#">Back to top</a></p></footer><script src="https://www.mirkosertic.de/js/bootstrap-native-v4.min.js"></script><script>function existsByCSSSelector(aSelector) {
        var element = document.querySelector(aSelector);
        if (element) {
            return true;
        }
        return false;
    }

    var Loader = function () { };
    Loader.prototype = {
        require: function (scripts, callback) {
            this.loadCount = 0;
            this.totalRequired = scripts.length;
            this.callback = callback;

            for (var i=0;i<scripts.length;i++) {
                this.writeScript(scripts[i]);
            }
        },
        loaded: function (evt) {
            this.loadCount++;

            if (this.loadCount==this.totalRequired && typeof this.callback=='function') this.callback.call();
        },
        writeScript: function (src) {
            var self = this;
            var s = document.createElement('script');
            s.type = "text/javascript";
            s.async = true;
            s.src = src;
            s.addEventListener('load', function (e) { self.loaded(e); }, false);
            var head = document.getElementsByTagName('head')[0];
            head.appendChild(s);
        }
    };

    if (existsByCSSSelector("pre.highlight code") > 0) {
        var loader = new Loader();
        loader.require(["https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"], function() {

            var additionalStylesheet = document.createElement('link');
            additionalStylesheet.rel = "stylesheet";
            additionalStylesheet.type = 'text/css';
            additionalStylesheet.media = "screen";
            additionalStylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";

            var head = document.getElementsByTagName('head')[0];
            head.appendChild(additionalStylesheet);

            hljs.highlightAll();
        });
    }</script></body></html>