<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Tuning HTML5 Canvas.fillText() &middot; Mirko Sertic</title><meta name="description" content="Two years ago I wrote a Java based GameEngine. I used technologies such as GWT and TeaVM to transpile the Java source code to JavaScript. The Game Engine used the HTML5 Canvas to render the current game state representation to the user. For the past few weeks I had some time to implement new features for this cool engine. I also did some profiling to see if there are bottlenecks in the rendering code. During the profiling sessions already known facts became visible: some browsers perform better than others."><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="generator" content="Hugo 0.80.0"><meta name="robots" content="index,follow"><meta property="og:title" content="Tuning HTML5 Canvas.fillText()"><meta property="og:description" content="Two years ago I wrote a Java based GameEngine. I used technologies such as GWT and TeaVM to transpile the Java source code to JavaScript. The Game Engine used the HTML5 Canvas to render the current game state representation to the user. For the past few weeks I had some time to implement new features for this cool engine. I also did some profiling to see if there are bottlenecks in the rendering code. During the profiling sessions already known facts became visible: some browsers perform better than others."><meta property="og:type" content="article"><meta property="og:url" content="https://www.mirkosertic.de/blog/2015/03/tuning-html5-canvas-filltext/"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="https://www.mirkosertic.de/css/site.css" rel="stylesheet" media="screen"><link rel="shortcut icon" type="image/x-icon" href="https://www.mirkosertic.de/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="https://www.mirkosertic.de/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://www.mirkosertic.de/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://www.mirkosertic.de/favicon-16x16.png"><link rel="manifest" href="https://www.mirkosertic.de/manifest.json"><link rel="mask-icon" href="https://www.mirkosertic.de/safari-pinned-tab.svg" color="#5bbad5"><script src="https://polyfill.io/v2/polyfill.min.js?features=default,IntersectionObserver"></script><meta name="theme-color" content="#ffffff"><script type="application/javascript">var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-33614060-2', 'auto');
	
	ga('send', 'pageview');
}</script><script async src="https://www.google-analytics.com/analytics.js"></script></head><body itemscope itemtype="http://schema.org/WebPage"><header><nav class="navbar navbar-expand-md navbar-dark fixed-top" itemscope itemtype="http://www.schema.org/SiteNavigationElement"><div class="container"><a class="navbar-brand" href="https://www.mirkosertic.de/">www.mirkosertic.de</a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav mr-auto"><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/toolsgoodies" title="Tools &amp; Goodies">Tools &amp; Goodies</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/interestingbooks" title="Interesting Books">Interesting Books</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/favorites" title="My favorite postings">My favorite postings</a></li><li class="nav-item"><a itemprop="url" class="nav-link active" href="/post/" title="Blog">Blog</a></li></ul></div></div></nav></header><main role="main"><div itemprop="mainEntity" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Tuning HTML5 Canvas.fillText()</h1><p class="post-date"><span class="icon"><i class="fa fa-calendar-check-o-white"></i></span><time datetime="2015-03-25" itemprop="datePublished">Wed, Mar 25, 2015</time> <span>by</span> <span itemprop="author" itemscope="" itemtype="https://schema.org/Person"><span itemprop="name"><a href="https://twitter.com/mirkosertic" itemprop="url" rel="author">Mirko Sertic</a></span></span></p><p><span class="icon"><i class="fa fa-clock-white"></i></span><span>3 Minutes reading time</span></p><p class="post-tags"><span class="tag"><span class="icon"><i class="fa fa-tags-white"></i></span><a href="/tags/html5">HTML5</a></span> ,&nbsp;<a href="/tags/performance">Performance</a> ,&nbsp;<a href="/tags/web">Web</a> ,&nbsp;<a href="/tags/javascript">JavaScript</a></p></header><article class="post-content clearfix" itemprop="articleBody"><div class="paragraph"><p>Two years ago I wrote a Java based <a href="https://www.mirkosertic.de/blog/2013/11/a-javafx-based-game-authoring-system/">GameEngine</a>. I used technologies such as GWT and TeaVM to transpile the Java source code to JavaScript. The Game Engine used the HTML5 Canvas to render the current game state representation to the user. For the past few weeks I had some time to implement new features for this cool engine. I also did some profiling to see if there are bottlenecks in the rendering code. During the profiling sessions already known facts became visible: some browsers perform better than others.</p></div><div class="paragraph"><p>I did expect this. What I did not expect was the identified bottleneck. Surprisingly the fillText() implementation of the HTML5 Canvas was terribly slow. I did expect something related to the JBox2D physics simulation. I did not expect the fillText() to be under the top CPU consumers.</p></div><div class="paragraph"><p>Here is a summary of my measurements:</p></div><table class="tableblock frame-all grid-all stretch"><colgroup><col style="width: 33.3333%;"><col style="width: 33.3333%;"><col style="width: 33.3334%;"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Platform</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Framerate</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Comments</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Chrome 39.0.2171(Linux Core I7 2.4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">5ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">only 1 % is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Firefox 36.0.4(Linux Core I7 2.4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">41% is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Firefox 36.0.4(Windows Core I7 4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">3ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10% is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Chrome 41.0.2272(Windows Core I7 4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">3ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">only 1 % is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">IE11.0.9600(Windows Core I7 4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">~3ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td></tr></tbody></table><div class="paragraph"><p>Wow! Seemed like the Firefox fillText() implementation was terribly slow on some platforms! Only the Chrome implementation seemed to be very efficient. Well, how can we tune this? It turned out that the rendered text was almost static, and changed only from time to time, triggered by game events such as player score changes.</p></div><div class="paragraph"><p>Now, do we always have to call the slow fillText() method? Well no! We can cache the result, and just draw it as a bitmap! For every text to be rendered, we can create an Offscreen Canvas element, draw the text only once, and use the Canvas as a bitmap resource to render it using the drawImage() method. An Offscreen Canvas element is a Canvas element, but it is not added to the DOM, and hence it does not become visible at all. It is just used for caching and for performance improvements.</p></div><div class="paragraph"><p>After implementing this new HTML5 text drawing technique, my profiling results changed a bit to:</p></div><table class="tableblock frame-all grid-all stretch"><colgroup><col style="width: 33.3333%;"><col style="width: 33.3333%;"><col style="width: 33.3334%;"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Platform</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Framerate</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Comments</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Chrome 39.0.2171(Linux I7 2.4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">4ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">only 1 % is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Firefox 36.0.4(Linux Core I7 2.4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">1ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">&lt;1% is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Firefox 36.0.4(Windows Core I7 4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">&lt;1ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">&lt;1% is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Chrome 41.0.2272(Windows Core I7 4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">&lt;1ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">&lt;1 % is used by fillText()</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">IE11.0.9600(Windows Core I7 4GHz)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">~1ms / frame</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td></tr></tbody></table><div class="paragraph"><p>Now this was fast! Rendering time decreased dramatically, and now JBox2D is my next bottleneck to tune :-) Surprisingly the Chrome 39 Linux performance did not change so extremely. This is due to the fact that on my Linux box the Canvas.clearRect() seemed to be a big performance problem. I will analyze this further. I hope that everyone else can use the above described technique to tune the HTML5 Canvas text rendering performance!</p></div><div class="paragraph"><p>Links:</p></div><div class="paragraph"><p>The source code is available for free on GitHub: <a href="https://github.com/mirkosertic/GameComposer">github.com/mirkosertic/GameComposer</a> Example Game backed by the TeaVM Renderer (tuned version): <a href="http://mirkosertic.github.io/GameComposer/games/teavm/platformer/index.html">mirkosertic.github.io/GameComposer/games/teavm/platformer/index.html</a></p></div><div class="metainfo"><span>&lt;&lt;Pevious posting: <a href="https://www.mirkosertic.de/blog/2014/12/gwt-vs-dragome-vs-teavm-for-game-programming/">GWT vs. Dragome vs. TeaVM for Game Programming</a></span> <span>Next posting: <a href="https://www.mirkosertic.de/blog/2015/04/a-javafx-based-lua-editor/">A JavaFX based LUA editor</a>&gt;&gt;</span></div><p><i class="fa fa-github"></i>Git revision: <a href="https://github.com/mirkosertic/www_mirkosertic_de/commit/63a36b07236d1869ff91cec0ebccf5aa005e0057" target="_blank">63a36b0</a></p></article></div><div class="comments"><div id="disqus-placeholder">Loading comments...</div><div id="disqus_thread"></div><script>'use strict';
        window.addEventListener("load", function(event) {
            var disqusLoaded = false;
            var disqusObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (!disqusLoaded && entry.isIntersecting) {
                        console.log("Loading Disqus");
                        disqusLoaded = true;

                        document.getElementById('disqus-placeholder').remove();

                        
                        var script = document.createElement('script');
                        script.src = '//www-mirkosertic-de.disqus.com/embed.js';
                        script.async = true;
                        script.setAttribute('data-timestamp', +new Date());
                        script.addEventListener('load', function () {
                            
                            DISQUS.reset({reload: true, config: false});
                        });
                        (document.head || document.body).appendChild(script);
                    }
                });
            }, {
                root: null,
                rootMargin: "0px",
                threshold: [0]
            });
            disqusObserver.observe(document.querySelector(".comments"));
        }, false);</script></div></main><footer><p>&copy; Mirko Sertic &middot; <a href="https://www.mirkosertic.de/global/impressum/index.html">Imprint / Impressum</a></p><address><strong itemprop="name">Mirko Sertic</strong><div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"><div itemprop="streetAddress">Josefine-Mauser-Str. 66</div><div itemprop="postalCode">48157 Münster</div><div itemprop="addressCountry">Germany</div></div><a class="icon" target="_top" href="mailto:mirko@mirkosertic.de"><i class="fa fa-envelope-white"></i></a> <a class="icon" target="_blank" href="https://www.mirkosertic.de/index.xml" itemprop="url"><i class="fa fa-rss-white"></i></a> <a class="icon" target="_blank" href="https://www.xing.com/profile/Mirko_Sertic" itemprop="url"><i class="fa fa-xing-white"></i></a> <a class="icon" target="_blank" href="https://twitter.com/mirkosertic" itemprop="url"><i class="fa fa-twitter-white"></i></a> <a class="icon" target="_blank" href="https://github.com/mirkosertic" itemprop="url"><i class="fa fa-github-white"></i></a> <a class="icon" target="_blank" href="https://de.linkedin.com/in/mirko-sertic-98882397" itemprop="url"><i class="fa fa-linkedin-white"></i></a></address><p class="float-right"><a href="#">Back to top</a></p></footer><script src="https://www.mirkosertic.de/js/bootstrap-native-v4.min.js"></script><script>function existsByCSSSelector(aSelector) {
        var element = document.querySelector(aSelector);
        if (element) {
            return true;
        }
        return false;
    }

    var Loader = function () { };
    Loader.prototype = {
        require: function (scripts, callback) {
            this.loadCount = 0;
            this.totalRequired = scripts.length;
            this.callback = callback;

            for (var i=0;i<scripts.length;i++) {
                this.writeScript(scripts[i]);
            }
        },
        loaded: function (evt) {
            this.loadCount++;

            if (this.loadCount==this.totalRequired && typeof this.callback=='function') this.callback.call();
        },
        writeScript: function (src) {
            var self = this;
            var s = document.createElement('script');
            s.type = "text/javascript";
            s.async = true;
            s.src = src;
            s.addEventListener('load', function (e) { self.loaded(e); }, false);
            var head = document.getElementsByTagName('head')[0];
            head.appendChild(s);
        }
    };

    if (existsByCSSSelector("pre.highlight code") > 0) {
        var loader = new Loader();
        loader.require(["https:\/\/www.mirkosertic.de\/js/highlight-9.9.0.min.js"], function() {

            var additionalStylesheet = document.createElement('link');
            additionalStylesheet.rel = "stylesheet";
            additionalStylesheet.type = 'text/css';
            additionalStylesheet.media = "screen";
            additionalStylesheet.href = "https:\/\/www.mirkosertic.de\/css/highlight.css";

            var head = document.getElementsByTagName('head')[0];
            head.appendChild(additionalStylesheet);

            hljs.initHighlightingOnLoad();
        });
    }</script></body></html>