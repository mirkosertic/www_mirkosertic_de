<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Smart Domain-Driven Queries: Leverage Your Domain Objects for Search Specifications &middot; Mirko Sertic</title><meta name="description" content="Transform your domain objects into powerful query specifications without writing redundant code! Using Mogwai SpecificationBuilder, domain objects become dynamic query builders through clever proxy magic, making database searches both elegant and maintainable - just like creating mocks, but for queries."><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="robots" content="index,follow"><meta property="og:title" content="Smart Domain-Driven Queries: Leverage Your Domain Objects for Search Specifications"><meta property="og:description" content="Transform your domain objects into powerful query specifications without writing redundant code! Using Mogwai SpecificationBuilder, domain objects become dynamic query builders through clever proxy magic, making database searches both elegant and maintainable - just like creating mocks, but for queries."><meta property="og:type" content="article"><meta property="og:url" content="https://www.mirkosertic.de/blog/2012/07/reusing-domain-objects-to-create-query-specifications/"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="https://www.mirkosertic.de/css/site.css" rel="stylesheet" media="screen"><link rel="shortcut icon" type="image/x-icon" href="https://www.mirkosertic.de/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="https://www.mirkosertic.de/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://www.mirkosertic.de/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://www.mirkosertic.de/favicon-16x16.png"><link rel="manifest" href="https://www.mirkosertic.de/manifest.json"><link rel="mask-icon" href="https://www.mirkosertic.de/safari-pinned-tab.svg" color="#5bbad5"><meta name="theme-color" content="#ffffff"></head><body itemscope itemtype="http://schema.org/WebPage"><header><nav class="navbar navbar-expand-md navbar-dark fixed-top" itemscope itemtype="http://www.schema.org/SiteNavigationElement"><div class="container"><a class="navbar-brand" href="https://www.mirkosertic.de/">www.mirkosertic.de</a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav mr-auto"><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/toolsgoodies" title="Tools &amp; Goodies">Tools &amp; Goodies</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/interestingbooks" title="Interesting Books">Interesting Books</a></li><li class="nav-item"><a itemprop="url" class="nav-link" href="/global/favorites" title="My favorite postings">My favorite postings</a></li><li class="nav-item"><a itemprop="url" class="nav-link active" href="/post/" title="Blog">Blog</a></li></ul></div></div></nav></header><main role="main"><div itemprop="mainEntity" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><div class="contentbox"><h1 class="post-title" itemprop="name headline">Smart Domain-Driven Queries: Leverage Your Domain Objects for Search Specifications</h1><p class="post-date"><span class="icon"><i class="fa fa-calendar-check-o-white"></i></span><time datetime="2012-07-20" itemprop="datePublished">Fri, Jul 20, 2012</time> <span>by</span> <span itemprop="author" itemscope="" itemtype="https://schema.org/Person"><span itemprop="name"><a href="https://x.com/mirkosertic" itemprop="url" rel="author">Mirko Sertic</a></span></span></p><p class="post-abstract" itemprop="abstract"><span>This article explores an innovative approach to creating database query specifications by reusing domain objects instead of creating separate query objects or writing raw Hibernate/JPA queries. Using the Mogwai SpecificationBuilder library, developers can leverage existing domain models to construct type-safe, refactoring-friendly query specifications through CGLib proxies. This method reduces code redundancy, maintains clean repository interfaces, and provides a natural way to express search criteria while avoiding the complexity of traditional query specifications or the brittleness of direct HQL/Criteria usage.</span></p><p><span class="icon"><i class="fa fa-clock-white"></i></span><span>4 Minutes reading time</span></p><p class="post-tags"><span class="tag"><span class="icon"><i class="fa fa-tags-white"></i></span><a href="/tags/database">Database</a> ,<a href="/tags/enterprise">Enterprise</a></span></p></div></header><article class="post-content clearfix" itemprop="articleBody"><div class="sect1"><h2 id="_problem">Problem</h2><div class="sectionbody"><div class="paragraph"><p>Often you need to create query specifications to retrieve data from persistent memory. One of the following patterns is most likely used:</p></div><div class="paragraph"><p>Bind Entity or Service with a distinct Query Object to the repository. A Service creates a distinct query object, passes it to the repository. Here the query object is translated to a Hibernate or JPA Criteria or HQL Statement and finally executed against the database.</p></div><div class="paragraph"><p>Pros:</p></div><div class="ulist"><ul><li><p>For every use case a distinct <a href="http://martinfowler.com/eaaCatalog/queryObject.html">Query Object</a> can be created. This helps a lot to encapsulate domain logic.</p></li></ul></div><div class="paragraph"><p>Cons:</p></div><div class="ulist"><ul><li><p>The query object and the Entites or Aggregates can be quite redundant, if you use techniques like <a href="http://de.wikipedia.org/wiki/Query_by_Example">Query by example</a>. Also, those query objects cannot be reused for other use cases. This avoids a “Generic” Repository interface.</p></li></ul></div><div class="paragraph"><p>Bind Entity or Service with specification to the repository. A Service creates a query <a href="http://martinfowler.com/apsupp/spec.pdf">Specification</a> and passes it to the repository. Here the query object is translated to a Hibernate or JPA Criteria or HQL Statement and finally executed against the database.</p></div><div class="paragraph"><p>Pros:</p></div><div class="ulist"><ul><li><p>A specification is a more general form of query object. It helps to keep the Repository interface lean.</p></li></ul></div><div class="paragraph"><p>Cons:</p></div><div class="ulist"><ul><li><p>Specifications can be tricky to implement.</p></li></ul></div><div class="paragraph"><p>Use Hibernate Criteria or HQL directly. A Service creates a Hibernate Criteria, passes it as a Query Object to the Repository, and it is executed against the database,</p></div><div class="paragraph"><p>Pros:</p></div><div class="ulist"><ul><li><p>No pros. This is just ugly.</p></li></ul></div><div class="paragraph"><p>Cons:</p></div><div class="ulist"><ul><li><p>Criteria or HQL are referencing Classes or even properties directly. This makes it a possible problem for refactoring. You can use the <a href="http://docs.jboss.org/hibernate/jpamodelgen/1.0/reference/en-US/html_single/">JPA2 Meta Model</a> to avoid this problem, but this also introduces a new concept which is more likely just a workaround.</p></li></ul></div></div></div><div class="sect1"><h2 id="_solution">Solution</h2><div class="sectionbody"><div class="paragraph"><p>Why not use reuse the domain objects to create a query specification or query object? I mean to reuse the structure and behavior. We are already doing something like this to create <a href="http://de.wikipedia.org/wiki/Mock-Objekt">Mock Objects</a> with EasyMock/PowerMock or Mockito. Why not do the same thing to create query specifications?</p></div><div class="paragraph"><p>Pros:</p></div><div class="ulist"><ul><li><p>The Repository will become a lean interface, just accepting a general query specification and finder methods to retrieve Entites by identifier. A large amount of search use cases can be unified.</p></li></ul></div><div class="paragraph"><p>Cons:</p></div><div class="ulist"><ul><li><p>Some use cases cannot be modeled this way, for instance projection queries or count/aggregate functions.</p></li></ul></div><div class="paragraph"><p>Project Mogwai provides a library called <a href="http://sourceforge.net/projects/mogwai/files/Mogwai%20SpecificationBuilder/">Mogwai SpecificationBuilder</a> to do it just this way.</p></div><div class="paragraph"><p>Example:Given are the following classes:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">public class Person {

    private String name1;
    private String name2;
    private String name3;
    private long sallary;

    private Address address;

    public Person() {
        address = new Address();
    }

    public String getName1() {
        return name1;
    }

    public void setName1(String name1) {
        this.name1 = name1;
    }

    public String getName2() {
        return name2;
    }

    public void setName2(String name2) {
        this.name2 = name2;
    }

    public Address getAddress() {
        return address;
    }

    public void setAddress(Address address) {
        this.address = address;
    }

    public String getName3() {
        return name3;
    }

    public void setName3(String name3) {
        this.name3 = name3;
    }

    public long getSallary() {
        return sallary;
    }

    public void setSallary(long sallary) {
        this.sallary = sallary;
    }
}

public class Address {

    private String zipCode;
    private City city;

    public Address() {
        city = new City();
    }

    public String getZipCode() {
        return zipCode;
    }

    public void setZipCode(String zipCode) {
        this.zipCode = zipCode;
    }

    public City getCity() {
        return city;
    }

    public void setCity(City city) {
        this.city = city;
    }
}

public class City {

    private String name;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}</code></pre></div></div><div class="paragraph"><p>Use case 1: a simple search for all Person entities with a given Name1 and Name2</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">ConjunctionSpecification&lt;Person&gt; theSpecification = new ConjunctionSpecification&lt;Person&gt;(new Person());

Person thePerson = theSpecification.root();
thePerson.setName1(&#34;SuchString1&#34;);
thePerson.setName2(&#34;SuchString2&#34;);</code></pre></div></div><div class="paragraph"><p>will result in the following query string:</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code>(name1 = {SuchString1}AND name2 = {SuchString2})</code></pre></div></div><div class="paragraph"><p>Usecase 2: a simple search for all Person entities with a given Name1 and nor a given Name2</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">ConjunctionSpecification&lt;Person&gt; theSpecification = new ConjunctionSpecification&lt;Person&gt;(new Person());

Person thePerson = theSpecification.root();
thePerson.setName1(&#34;SuchString1&#34;);
theSpecification.notEquals().setName2(&#34;SuchString2&#34;);</code></pre></div></div><div class="paragraph"><p>will result in the following query string:</p></div><div class="paragraph"><p>(name1 = {SuchString1} AND name2 != {SuchString2})</p></div><div class="paragraph"><p>Usecase 3: a like search for all Person entities</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">ConjunctionSpecification&lt;Person&gt; theSpecification = new ConjunctionSpecification&lt;Person&gt;(new Person());

Person thePerson = theSpecification.root();
thePerson.setName1(&#34;SuchString1&#34;);
theSpecification.like().setName2(&#34;%lala%&#34;);</code></pre></div></div><div class="paragraph"><p>will result in the following query string:</p></div><div class="paragraph"><p>(name1 = {SuchString1} AND name2 LIKE {%lala%}</p></div><div class="paragraph"><p>Usecase 4: traversing aggregated Entities</p></div><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">ConjunctionSpecification&lt;Person&gt; theSpecification = new ConjunctionSpecification&lt;Person&gt;(new Person());

Person thePerson = theSpecification.root();
thePerson.getAddress().getCity().setName(&#34;Berne&#34;);</code></pre></div></div><div class="paragraph"><p>will result in the following query string:</p></div><div class="paragraph"><p>(address.city.name = {Berne})</p></div></div></div><div class="sect1"><h2 id="_under_the_hood">Under the hood</h2><div class="sectionbody"><div class="paragraph"><p>Mogwai SpecificationBuilder creates CGLib proxies for domain objects. These proxies capture the invoked behavior on the domain objects and creating a corresponding query specification. The proxies also handle object graph navigation.</p></div></div></div><div class="sect1"><h2 id="_conclusion">Conclusion</h2><div class="sectionbody"><div class="paragraph"><p>Mogwai SpecificationBuilder helps to create query specifications for a large amount of use cases without introducing additional concepts. Recorded query specifications can be converted into Hibernate Criteria or HQL statements in a very generic and reusable way. This helps to keep the Repository interface clean and is also very refactoring safe. For further investigations, you can also consult the <a href="http://www.querydsl.com/">Query DSL Project</a>. It combines a kind of JPA2 Meta model with query specifications.</p></div></div></div><div class="metainfo"><span>&lt;&lt;Pevious posting: <a href="https://www.mirkosertic.de/blog/2012/06/swing-databinding-with-mogwai-databinding/">Effortless Java Swing Data Binding: A Guide to Mogwai Framework</a></span> <span>Next posting: <a href="https://www.mirkosertic.de/blog/2012/07/xml-resourcebundles-and-how-to-make-i18n-refactoring-safe/">Simplify I18N: XML-Based Resource Bundles for Safer Java Internationalization</a>&gt;&gt;</span></div><p><i class="fa fa-github"></i>Git revision: <a href="https://github.com/mirkosertic/www_mirkosertic_de/commit/c80594730cca2933f4a385caf46fddef187449d3" target="_blank">c805947</a></p></article></div></main><footer><p>&copy; Mirko Sertic &middot; <a href="https://www.mirkosertic.de/global/impressum/index.html">Imprint / Impressum</a></p><address><strong itemprop="name">Mirko Sertic</strong><div itemprop="address" itemscope itemtype="http://schema.org/PostalAddress"><div itemprop="streetAddress">Josefine-Mauser-Str. 66</div><div itemprop="postalCode">48157 Münster</div><div itemprop="addressCountry">Germany</div></div><a class="icon" target="_top" href="mailto:mirko@mirkosertic.de"><i class="fa fa-envelope-white"></i></a> <a class="icon" target="_blank" href="https://x.com/mirkosertic" itemprop="url"><i class="fa fa-x-twitter-white"></i></a> <a class="icon" target="_blank" href="https://github.com/mirkosertic" itemprop="url"><i class="fa fa-github-white"></i></a> <a class="icon" target="_blank" href="https://de.linkedin.com/in/mirko-sertic-98882397" itemprop="url"><i class="fa fa-linkedin-white"></i></a></address><p class="float-right"><a href="#">Back to top</a></p></footer><script src="https://www.mirkosertic.de/js/bootstrap-native-v4.min.js"></script><script>function existsByCSSSelector(aSelector) {
        var element = document.querySelector(aSelector);
        if (element) {
            return true;
        }
        return false;
    }

    var Loader = function () { };
    Loader.prototype = {
        require: function (scripts, callback) {
            this.loadCount = 0;
            this.totalRequired = scripts.length;
            this.callback = callback;

            for (var i=0;i<scripts.length;i++) {
                this.writeScript(scripts[i]);
            }
        },
        loaded: function (evt) {
            this.loadCount++;

            if (this.loadCount==this.totalRequired && typeof this.callback=='function') this.callback.call();
        },
        writeScript: function (src) {
            var self = this;
            var s = document.createElement('script');
            s.type = "text/javascript";
            s.async = true;
            s.src = src;
            s.addEventListener('load', function (e) { self.loaded(e); }, false);
            var head = document.getElementsByTagName('head')[0];
            head.appendChild(s);
        }
    };

    if (existsByCSSSelector("pre.highlight code") > 0) {
        var loader = new Loader();
        loader.require(["https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"], function() {

            var additionalStylesheet = document.createElement('link');
            additionalStylesheet.rel = "stylesheet";
            additionalStylesheet.type = 'text/css';
            additionalStylesheet.media = "screen";
            additionalStylesheet.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";

            var head = document.getElementsByTagName('head')[0];
            head.appendChild(additionalStylesheet);

            hljs.highlightAll();
        });
    }</script></body></html>